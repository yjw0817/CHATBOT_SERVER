{% extends "base.html" %}

{% block content %}
<section class="chat-section">
    <h2>üí¨ Chat with Citations</h2>

    <div class="chat-controls">
        <select id="apt-select">
            <option value="">-- ÏïÑÌååÌä∏ ÏÑ†ÌÉù --</option>
            {% for apt in apartments %}
            <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
            {% endfor %}
        </select>
        <button id="chat-btn-local" onclick="switchChatMode('local')" style="padding:3px 10px;border-radius:12px;font-size:12px;border:1px solid #d1d5db;background:#fff;color:#374151;cursor:pointer;">Local</button>
        <button id="chat-btn-remote" onclick="switchChatMode('remote')" style="padding:3px 10px;border-radius:12px;font-size:12px;border:1px solid #d1d5db;background:#fff;color:#374151;cursor:pointer;">Remote</button>
        <select id="model-select">
            <option value="">-- Î™®Îç∏ Î°úÎî©... --</option>
        </select>
        <span id="model-badge" class="badge badge-pending" style="cursor:pointer;" title="ÌòÑÏû¨ LLM Î™®Îç∏">loading...</span>
        <span id="status-badge" class="badge" style="display:none;"></span>
    </div>

    <div class="chat-container">
        <div id="chat-messages" class="messages">
            <div class="message system">
                ÏïÑÌååÌä∏Î•º ÏÑ†ÌÉùÌïòÍ≥† ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
            </div>
        </div>

        <form id="chat-form" class="chat-input" onsubmit="sendMessage(event)">
            <input type="text" id="chat-input" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî... (Ïòà: ÌôòÎ∂à Í∑úÏ†ï ÏïåÎ†§Ï§ò)" disabled>
            <button type="submit" id="send-btn" disabled>Ï†ÑÏÜ°</button>
        </form>
    </div>
</section>

<script>
    let currentAptId = null;
    let conversationId = null;

    document.getElementById('apt-select').addEventListener('change', function () {
        currentAptId = this.value;
        const input = document.getElementById('chat-input');
        const btn = document.getElementById('send-btn');
        if (currentAptId) {
            input.disabled = false;
            btn.disabled = false;
            conversationId = null; // Reset conversation
            document.getElementById('chat-messages').innerHTML = '<div class="message system">ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>';
        } else {
            input.disabled = true;
            btn.disabled = true;
        }
    });

    async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message || !currentAptId) return;

        // Add user message
        addMessage('user', message);
        input.value = '';

        // Show loading
        const loadingDiv = addMessage('assistant', 'ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...');

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apt_id: currentAptId,
                    client_id: 'web-user',
                    conversation_id: conversationId,
                    message: message,
                    model: document.getElementById('model-select').value || null
                })
            });
            const data = await res.json();

            // Update conversation ID
            conversationId = data.conversation_id;

            // Remove loading and add real response
            loadingDiv.remove();
            addAssistantMessage(data);

        } catch (err) {
            loadingDiv.innerHTML = 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message;
        }
    }

    function addMessage(role, text) {
        const messagesDiv = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        msgDiv.textContent = text;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return msgDiv;
    }

    // Chat: mode toggle + dynamic model list
    const EMBED_MODELS = ['bge-m3', 'nomic-embed-text'];

    function updateChatModeUI(mode) {
        const btnL = document.getElementById('chat-btn-local');
        const btnR = document.getElementById('chat-btn-remote');
        const active = 'padding:3px 10px;border-radius:12px;font-size:12px;border:1px solid transparent;cursor:pointer;font-weight:700;';
        const inactive = 'padding:3px 10px;border-radius:12px;font-size:12px;border:1px solid #d1d5db;background:#fff;color:#374151;cursor:pointer;';
        if (btnL && btnR) {
            if (mode === 'local') {
                btnL.style.cssText = active + 'background:#10b981;color:white;';
                btnR.style.cssText = inactive;
            } else {
                btnR.style.cssText = active + 'background:#3b82f6;color:white;';
                btnL.style.cssText = inactive;
            }
        }
    }

    function populateChatModelSelect(rawModels, currentModel) {
        const sel = document.getElementById('model-select');
        const badge = document.getElementById('model-badge');
        const saved = localStorage.getItem('chat_model');
        const models = (rawModels || []).filter(m => !EMBED_MODELS.some(e => m.name.startsWith(e)));
        sel.innerHTML = '<option value="">-- Î™®Îç∏ ÏÑ†ÌÉù --</option>';
        let target = null;
        const names = models.map(m => m.name);
        if (saved && names.includes(saved)) target = saved;
        else if (currentModel && names.includes(currentModel)) target = currentModel;
        else if (models.length) target = models[0].name;
        for (const m of models) {
            const opt = document.createElement('option');
            opt.value = m.name;
            opt.textContent = m.name + (m.size_gb ? ` (${m.size_gb}GB)` : '');
            if (m.name === target) opt.selected = true;
            sel.appendChild(opt);
        }
        if (target) localStorage.setItem('chat_model', target);
        badge.textContent = sel.value || 'default';
    }

    async function loadChatModelList() {
        const sel = document.getElementById('model-select');
        sel.innerHTML = '<option value="">Î™®Îç∏ Î°úÎî©...</option>';
        try {
            const res = await fetch('/api/llm/models');
            const data = await res.json();
            populateChatModelSelect(data.models, data.current);
        } catch(e) {
            console.warn('Model list load failed:', e);
            document.getElementById('model-badge').textContent = 'error';
        }
    }

    async function switchChatMode(mode) {
        const btnL = document.getElementById('chat-btn-local');
        const btnR = document.getElementById('chat-btn-remote');
        if (btnL) btnL.disabled = true;
        if (btnR) btnR.disabled = true;
        document.getElementById('model-select').innerHTML = '<option value="">Î™®Îç∏ Î°úÎî©...</option>';
        try {
            const res = await fetch('/api/llm/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `mode=${mode}`
            });
            const data = await res.json();
            if (data.success) {
                updateChatModeUI(data.mode);
                if (data.models) populateChatModelSelect(data.models, data.info?.model);
            } else {
                alert(data.detail || 'Mode Ï†ÑÌôò Ïã§Ìå®');
            }
        } catch(e) { alert('Mode Ï†ÑÌôò Ïò§Î•ò: ' + e.message); }
        finally {
            if (btnL) btnL.disabled = false;
            if (btnR) btnR.disabled = false;
        }
    }

    // Init: load mode + models
    (async function() {
        try {
            const res = await fetch('/api/llm/mode');
            const data = await res.json();
            updateChatModeUI(data.mode);
        } catch(e) {}
        await loadChatModelList();
    })();

    document.getElementById('model-select').addEventListener('change', function () {
        const model = this.value;
        localStorage.setItem('chat_model', model);
        document.getElementById('model-badge').textContent = model || 'default';
    });

    function addAssistantMessage(data) {
        const messagesDiv = document.getElementById('chat-messages');

        const msgDiv = document.createElement('div');
        msgDiv.className = 'message assistant';

        // Confidence badge
        const confidenceClass = data.confidence === 'HIGH' ? 'badge-approved' :
            data.confidence === 'MED' ? 'badge-pending' : 'badge-draft';

        let html = `<div class="reply-header">
        <span class="badge ${confidenceClass}">${data.confidence}</span>
    </div>
    <div class="reply-text">${data.reply_text}</div>`;

        // Citations
        if (data.citations && data.citations.length > 0) {
            html += '<div class="citations"><strong>üìö Ï∂úÏ≤ò:</strong><ul>';
            for (const cite of data.citations) {
                html += `<li>
                <strong>${cite.doc_title || 'Î¨∏ÏÑú'}</strong> > ${cite.section_name}
                <br><small class="snippet">"${cite.snippet}"</small>
            </li>`;
            }
            html += '</ul></div>';
        }

        // Next question
        if (data.next_question) {
            html += `<div class="next-question">${data.next_question}</div>`;
        }

        // Timing info
        if (data.timing) {
            const t = data.timing;
            const parts = [];
            if (t.rag_s !== undefined) parts.push(`RAG ${t.rag_s}s`);
            if (t.llm_s !== undefined) parts.push(`LLM ${t.llm_s}s`);
            if (t.total_s !== undefined) parts.push(`Total ${t.total_s}s`);
            const method = data.search_method === 'faiss' ? 'FAISS' : 'Keyword';
            html += `<div class="timing-info">${method} | ${parts.join(' | ')}</div>`;
        }

        msgDiv.innerHTML = html;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>

<style>
    .reply-header {
        margin-bottom: 0.5rem;
    }

    .reply-text {
        margin-bottom: 0.75rem;
    }

    .citations {
        background: #f3f4f6;
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .citations ul {
        margin: 0.5rem 0 0 1.5rem;
        padding: 0;
    }

    .citations li {
        margin-bottom: 0.5rem;
    }

    .snippet {
        color: #6b7280;
        font-style: italic;
    }

    .next-question {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fef3c7;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .message.assistant {
        max-width: 90%;
    }

    .timing-info {
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: #e5e7eb;
        border-radius: 4px;
        font-size: 0.75rem;
        color: #6b7280;
        font-family: monospace;
    }

    #model-select {
        padding: 0.4rem;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
    }
</style>
{% endblock %}