{% extends "base.html" %}

{% block content %}
<section class="quality-section">
    <h2>âœ… Quality Gate</h2>
    <p class="description">ë¬¸ì„œ í’ˆì§ˆ ê²€ì¦ ê²°ê³¼ (ëˆ„ë½/ëª¨í˜¸/ì¶©ëŒ/ê°œì¸ì •ë³´/API í•„ìš” í•­ëª©)</p>

    <!-- Document selector -->
    <div class="card">
        <h3>ë¬¸ì„œ ì„ íƒ</h3>
        <select id="doc-select" onchange="loadIssues()">
            <option value="">-- ë¬¸ì„œ ì„ íƒ --</option>
            {% for doc in documents %}
            <option value="{{ doc.doc_id }}">{{ doc.title }} (v{{ doc.version }}) - {{ doc.status }}</option>
            {% endfor %}
        </select>
        <button class="btn-small" onclick="runQualityGate()">ğŸ”„ Quality Gate ì‹¤í–‰</button>
    </div>

    <div class="issues-container">
        {% set red_issues = issues | selectattr('severity', 'equalto', 'RED') | list %}
        {% set yellow_issues = issues | selectattr('severity', 'equalto', 'YELLOW') | list %}

        <div class="card issue-card red">
            <h3>ğŸ”´ RED Issues (<span id="red-count">{{ red_issues|length }}</span>)</h3>
            <div id="red-issues-list">
                {% if red_issues %}
                <ul>
                    {% for issue in red_issues %}
                    <li>
                        <strong>[{{ issue.issue_type }}]</strong> {{ issue.message }}
                        <br><small>ì œì•ˆ: {{ issue.suggestion }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="empty">RED ì´ìŠˆ ì—†ìŒ</p>
                {% endif %}
            </div>
        </div>

        <div class="card issue-card yellow">
            <h3>ğŸŸ¡ YELLOW Issues (<span id="yellow-count">{{ yellow_issues|length }}</span>)</h3>
            <div id="yellow-issues-list">
                {% if yellow_issues %}
                <ul>
                    {% for issue in yellow_issues %}
                    <li>
                        <strong>[{{ issue.issue_type }}]</strong> {{ issue.message }}
                        <br><small>ì œì•ˆ: {{ issue.suggestion }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="empty">YELLOW ì´ìŠˆ ì—†ìŒ</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="btn-primary" id="approve-btn" onclick="approveDoc()" disabled>âœ”ï¸ ìŠ¹ì¸ (Approve)</button>
        <small>* RED ì´ìŠˆê°€ ëª¨ë‘ í•´ê²°ë˜ì–´ì•¼ ìŠ¹ì¸ ê°€ëŠ¥</small>
    </div>
</section>

<script>
    let currentDocId = null;

    async function loadIssues() {
        const select = document.getElementById('doc-select');
        currentDocId = select.value;
        if (!currentDocId) return;

        try {
            const res = await fetch(`/api/doc/${currentDocId}/issues`);
            const issues = await res.json();

            const red = issues.filter(i => i.severity === 'RED');
            const yellow = issues.filter(i => i.severity === 'YELLOW');

            document.getElementById('red-count').textContent = red.length;
            document.getElementById('yellow-count').textContent = yellow.length;

            document.getElementById('red-issues-list').innerHTML = red.length
                ? '<ul>' + red.map(i => `<li><strong>[${i.issue_type}]</strong> ${i.message}<br><small>ì œì•ˆ: ${i.suggestion}</small></li>`).join('') + '</ul>'
                : '<p class="empty">RED ì´ìŠˆ ì—†ìŒ</p>';

            document.getElementById('yellow-issues-list').innerHTML = yellow.length
                ? '<ul>' + yellow.map(i => `<li><strong>[${i.issue_type}]</strong> ${i.message}<br><small>ì œì•ˆ: ${i.suggestion}</small></li>`).join('') + '</ul>'
                : '<p class="empty">YELLOW ì´ìŠˆ ì—†ìŒ</p>';

            document.getElementById('approve-btn').disabled = red.length > 0;
        } catch (e) {
            console.error(e);
        }
    }

    async function runQualityGate() {
        if (!currentDocId) {
            alert('ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”');
            return;
        }

        try {
            const res = await fetch(`/api/doc/${currentDocId}/quality-gate`, { method: 'POST' });
            const data = await res.json();

            if (res.ok) {
                alert(`Quality Gate ì™„ë£Œ!\nRED: ${data.red_count}, YELLOW: ${data.yellow_count}`);
                loadIssues();
            } else {
                alert('ì˜¤ë¥˜: ' + (data.detail || 'Unknown error'));
            }
        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    }

    async function approveDoc() {
        if (!currentDocId) return;

        try {
            const res = await fetch(`/api/doc/${currentDocId}/approve`, { method: 'POST' });
            const data = await res.json();

            if (res.ok) {
                alert(`ìŠ¹ì¸ ì™„ë£Œ! ì²­í¬ ${data.reindex.chunk_count}ê°œ ìƒì„±ë¨`);
                location.reload();
            } else {
                alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (data.detail || 'Unknown error'));
            }
        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    }
</script>
{% endblock %}