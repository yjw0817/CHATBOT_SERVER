{% extends "base.html" %}

{% block content %}
<section class="upload-section">
    <h2>ğŸ“¤ ë¬¸ì„œ ì—…ë¡œë“œ & ë§¤ë‰´ì–¼í™”</h2>

    <!-- Create Apartment -->
    <div class="card">
        <h3>ì•„íŒŒíŠ¸ ì¶”ê°€</h3>
        <form id="apt-form" hx-post="/api/apartments" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { this.reset(); location.reload(); }">
            <input type="text" name="apt_id" placeholder="ì•„íŒŒíŠ¸ ID (ì˜ˆ: APT001)" required>
            <input type="text" name="name" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„" required>
            <button type="submit">â• ì¶”ê°€</button>
        </form>
    </div>

    <!-- Upload Document -->
    <div class="card">
        <h3>ë¬¸ì„œ ì—…ë¡œë“œ</h3>
        <form id="upload-form" hx-post="/api/upload" hx-encoding="multipart/form-data" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) location.reload();">
            <select name="apt_id" required>
                <option value="">-- ì•„íŒŒíŠ¸ ì„ íƒ --</option>
                {% for apt in apartments %}
                <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
                {% endfor %}
            </select>
            <input type="file" name="file" accept=".docx,.pdf,.txt,.md" required>
            <button type="submit">ğŸ“ ì—…ë¡œë“œ</button>
        </form>
    </div>
</section>

<section class="doc-list">
    <h2>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ì•„íŒŒíŠ¸</th>
                <th>ë¬¸ì„œëª…</th>
                <th>ë²„ì „</th>
                <th>ìƒíƒœ</th>
                <th>ì—…ë¡œë“œì¼</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr class="status-{{ doc.status|lower }}" id="row-{{ doc.doc_id }}">
                <td>{{ doc.apt_name or doc.apt_id }}</td>
                <td>{{ doc.title }}</td>
                <td>v{{ doc.version }}</td>
                <td><span class="badge badge-{{ doc.status|lower }}">{{ doc.status }}</span></td>
                <td>{{ doc.created_at[:16] }}</td>
                <td class="actions-cell">
                    {% if doc.status != 'ARCHIVED' %}
                    <button class="btn-small btn-extract" onclick="extractText('{{ doc.doc_id }}')">ğŸ“„ Extract</button>
                    <button class="btn-small btn-manualize" onclick="manualize('{{ doc.doc_id }}')">ğŸ“
                        Manualize</button>
                    <button class="btn-small btn-gate" onclick="qualityGate('{{ doc.doc_id }}')">âœ… Gate</button>
                    <button class="btn-small btn-approve" onclick="approve('{{ doc.doc_id }}')">âœ”ï¸ Approve</button>
                    {% else %}
                    <span class="text-muted">Archived</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="empty">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Result Modal -->
<div id="result-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">ê²°ê³¼</h3>
        <div id="modal-body" class="argos-popup__body"></div>
        <div id="modal-buttons" style="display:none;margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;"></div>
    </div>
</div>

<script>
    async function apiCall(endpoint, method = 'POST') {
        try {
            const res = await fetch(endpoint, { method });
            const data = await res.json();
            return { ok: res.ok, data };
        } catch (e) {
            return { ok: false, data: { error: e.message } };
        }
    }

    function showModal(title, htmlContent) {
        document.getElementById('modal-title').textContent = title;
        const body = document.getElementById('modal-body');
        if (typeof htmlContent === 'string' && htmlContent.startsWith('<div')) {
            body.innerHTML = htmlContent;
        } else {
            body.innerHTML = `<pre class="argos-pre">${typeof htmlContent === 'string' ? htmlContent : JSON.stringify(htmlContent, null, 2)}</pre>`;
        }
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = '';
        btnArea.style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-buttons').innerHTML = '';
        document.getElementById('modal-buttons').style.display = 'none';
    }

    async function extractText(docId) {
        showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...', '<div class="argos-alert argos-alert--info">ë¬¸ì„œì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/extract-text`);
        if (ok) {
            const html = `
                <div class="argos-card">
                    <div class="argos-title">í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ</div>
                    <p class="argos-sub">ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì˜ ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤.</p>
                    <div class="argos-badges">
                        <span class="argos-badge argos-badge--info">ê¸€ì ìˆ˜: ${data.chars.toLocaleString()}ì</span>
                    </div>
                    <pre class="argos-pre">${data.preview}</pre>
                </div>
            `;
            showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ', html);
        } else {
            const errorHtml = `
                <div class="argos-card">
                    <div class="argos-title">ì˜¤ë¥˜</div>
                    <div class="argos-alert argos-alert--error">${data.detail || data.error}</div>
                </div>
            `;
            showModal('ì˜¤ë¥˜', errorHtml);
        }
    }

    function formatSections(details) {
        if (!details) return '';
        return Object.entries(details).map(([name, text]) => {
            const preview = text.length >= 300 ? text + '...' : text;
            return `ã€${name}ã€‘\n${preview}`;
        }).join('\n\n');
    }

    async function manualize(docId, force = false) {
        if (!force) {
            showModal('í™•ì¸ ì¤‘...', '<div class="argos-alert argos-alert--info">ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° í™•ì¸ ì¤‘...</div>');
        } else {
            showModal('ì²˜ë¦¬ ì¤‘...', '<div class="argos-alert argos-alert--info">LLMìœ¼ë¡œ ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>');
        }
        const url = force ? `/api/doc/${docId}/manualize?force=true` : `/api/doc/${docId}/manualize`;
        const { ok, data } = await apiCall(url);
        if (ok) {
            if (data.cached) {
                const html = `
                    <div class="argos-card">
                        <div class="argos-title">ë§¤ë‰´ì–¼í™” ë°ì´í„° í™•ì¸</div>
                        <p class="argos-sub">ì´ë¯¸ ìƒì„±ëœ ì„¹ì…˜ ëª©ë¡ì…ë‹ˆë‹¤.</p>
                        <ul class="argos-list">
                            ${data.sections.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                        <div class="argos-badges">
                            <span class="argos-badge argos-badge--info">ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©ë¨</span>
                        </div>
                    </div>
                `;
                showConfirmModal(
                    'ì´ë¯¸ ë§¤ë‰´ì–¼í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                    html,
                    () => manualize(docId, true)
                );
            } else {
                const html = `
                    <div class="argos-card">
                        <div class="argos-title">ë§¤ë‰´ì–¼í™” ì™„ë£Œ</div>
                        <p class="argos-sub">LLMì„ í†µí•´ ë¬¸ì„œë¥¼ êµ¬ì¡°í™”í–ˆìŠµë‹ˆë‹¤.</p>
                        <div class="argos-badges">
                            <span class="argos-badge argos-badge--info">ì„¹ì…˜: ${data.sections.length}ê°œ</span>
                            <span class="argos-badge ${data.llm_used ? 'argos-badge--ok' : 'argos-badge--yellow'}">LLM ì‚¬ìš©: ${data.llm_used}</span>
                        </div>
                        <ul class="argos-list">
                            ${data.sections.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
                showModal('ë§¤ë‰´ì–¼í™” ì™„ë£Œ', html);
            }
        } else {
            const errorHtml = `
                <div class="argos-card">
                    <div class="argos-title">ì˜¤ë¥˜</div>
                    <div class="argos-alert argos-alert--error">${data.detail || data.error}</div>
                </div>
            `;
            showModal('ì˜¤ë¥˜', errorHtml);
        }
    }

    async function qualityGate(docId) {
        showModal('í’ˆì§ˆ ê²€ì‚¬ ì¤‘...', '<div class="argos-alert argos-alert--info">LLMê³¼ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ë§¤ë‰´ì–¼ í’ˆì§ˆì„ ê²€ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/quality-gate`);
        if (ok) {
            const html = `
                <div class="argos-card">
                    <div class="argos-title">í’ˆì§ˆ ê²€ì‚¬(Gate) ê²°ê³¼</div>
                    <p class="argos-sub">REDëŠ” ìŠ¹ì¸ ë¶ˆê°€, YELLOWëŠ” ê°œì„  ê¶Œê³ ì…ë‹ˆë‹¤.</p>
                    <div class="argos-badges">
                        <span class="argos-badge argos-badge--red">RED: ${data.red_count}</span>
                        <span class="argos-badge argos-badge--yellow">YELLOW: ${data.yellow_count}</span>
                        <span class="argos-badge ${data.red_count === 0 ? 'argos-badge--ok' : 'argos-badge--red'}">
                            ${data.red_count === 0 ? 'Approve ê°€ëŠ¥' : 'Approve ë¶ˆê°€'}
                        </span>
                    </div>
                    ${data.issues.length > 0 ? `
                    <ul class="argos-list">
                        ${data.issues.map(it => `
                            <li>
                                <strong class="${it.severity === 'RED' ? 'text-danger' : 'text-warning'}">[${it.severity}/${it.issue_type}]</strong> 
                                ${it.message}
                                ${it.suggestion ? `<br><small style="color:#6b7280">ğŸ’¡ ì œì•ˆ: ${it.suggestion}</small>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ` : '<div class="argos-alert argos-alert--ok" style="margin-top:10px;">ê²€ì¶œëœ í’ˆì§ˆ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>'}
                </div>
            `;
            showModal('í’ˆì§ˆ ê²Œì´íŠ¸ ì™„ë£Œ', html);
        } else {
            const errorHtml = `
                <div class="argos-card">
                    <div class="argos-title">ì˜¤ë¥˜</div>
                    <div class="argos-alert argos-alert--error">${data.detail || data.error}</div>
                </div>
            `;
            showModal('ì˜¤ë¥˜', errorHtml);
        }
    }

    async function approve(docId) {
        showModal('ìŠ¹ì¸ ì¤‘...', '<div class="argos-alert argos-alert--info">ë¬¸ì„œë¥¼ ìŠ¹ì¸í•˜ê³  ê²€ìƒ‰ ì¸ë±ìŠ¤ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/approve`);
        if (ok) {
            const html = `
                <div class="argos-card">
                    <div class="argos-title">ìŠ¹ì¸ ë° ì¸ë±ì‹± ì™„ë£Œ</div>
                    <p class="argos-sub">ë¬¸ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <div class="argos-badges">
                        <span class="argos-badge argos-badge--ok">ìƒíƒœ: ${data.status}</span>
                        <span class="argos-badge argos-badge--info">ìƒì„±ëœ ì²­í¬: ${data.reindex.chunk_count}ê°œ</span>
                    </div>
                    <div class="argos-alert argos-alert--ok" style="margin-top:10px;">ì´ì œ ì±—ë´‡ì—ì„œ í•´ë‹¹ ë¬¸ì„œì˜ ë‚´ìš©ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    <button class="btn" style="width:100%;margin-top:10px;" onclick="location.reload()">í™•ì¸</button>
                </div>
            `;
            showModal('ìŠ¹ì¸ ì™„ë£Œ', html);
        } else {
            const errorHtml = `
                <div class="argos-card">
                    <div class="argos-title">ìŠ¹ì¸ ì‹¤íŒ¨</div>
                    <div class="argos-alert argos-alert--error">${data.detail || data.error}</div>
                </div>
            `;
            showModal('ìŠ¹ì¸ ì‹¤íŒ¨', errorHtml);
        }
    }

    function showConfirmModal(title, content, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        const body = document.getElementById('modal-body');
        if (typeof content === 'string' && content.startsWith('<div')) {
            body.innerHTML = content;
        } else {
            body.innerHTML = `<div class="argos-card"><pre class="argos-pre">${content}</pre></div>`;
        }
        
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ì·¨ì†Œ (ê¸°ì¡´ ìœ ì§€)</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-confirm-btn">ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” (LLM)</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => { closeModal(); onConfirm(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    // Close modal on outside click
    document.getElementById('result-modal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell button {
        margin: 2px;
    }

    .btn-extract {
        background: #6366f1;
    }

    .btn-manualize {
        background: #8b5cf6;
    }

    .btn-gate {
        background: #f59e0b;
    }

    .btn-approve {
        background: #10b981;
    }

    .text-muted {
        color: #9ca3af;
    }
</style>
{% endblock %}