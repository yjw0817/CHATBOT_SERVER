{% extends "base.html" %}

{% block content %}
<section class="upload-section">
    <h2>ğŸ“¤ ë¬¸ì„œ ì—…ë¡œë“œ & ë§¤ë‰´ì–¼í™”</h2>

    <!-- Create Apartment -->
    <div class="card">
        <h3>ì•„íŒŒíŠ¸ ì¶”ê°€</h3>
        <form id="apt-form" hx-post="/api/apartments" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { this.reset(); location.reload(); }">
            <input type="text" name="apt_id" placeholder="ì•„íŒŒíŠ¸ ID (ì˜ˆ: APT001)" required>
            <input type="text" name="name" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„" required>
            <button type="submit">â• ì¶”ê°€</button>
        </form>
    </div>

    <!-- Upload Document -->
    <div class="card">
        <h3>ë¬¸ì„œ ì—…ë¡œë“œ</h3>
        <form id="upload-form" hx-post="/api/upload" hx-encoding="multipart/form-data" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) location.reload();">
            <select name="apt_id" required>
                <option value="">-- ì•„íŒŒíŠ¸ ì„ íƒ --</option>
                {% for apt in apartments %}
                <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
                {% endfor %}
            </select>
            <input type="file" name="file" accept=".docx,.pdf,.txt,.md" required>
            <button type="submit">ğŸ“ ì—…ë¡œë“œ</button>
        </form>
    </div>
</section>

<section class="doc-list">
    <h2>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ì•„íŒŒíŠ¸</th>
                <th>ë¬¸ì„œëª…</th>
                <th>ë²„ì „</th>
                <th>ìƒíƒœ</th>
                <th>ì—…ë¡œë“œì¼</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr class="status-{{ doc.status|lower }}" id="row-{{ doc.doc_id }}">
                <td>{{ doc.apt_name or doc.apt_id }}</td>
                <td>{{ doc.title }}</td>
                <td>v{{ doc.version }}</td>
                <td><span class="badge badge-{{ doc.status|lower }}">{{ doc.status }}</span></td>
                <td>{{ doc.created_at[:16] }}</td>
                <td class="actions-cell">
                    {% if doc.status != 'ARCHIVED' %}
                    <button class="btn-small btn-extract" onclick="extractText('{{ doc.doc_id }}')">ğŸ“„ Extract</button>
                    <button class="btn-small btn-manualize" onclick="manualize('{{ doc.doc_id }}')">ğŸ“
                        Manualize</button>
                    <button class="btn-small btn-gate" onclick="qualityGate('{{ doc.doc_id }}')">âœ… Gate</button>
                    <button class="btn-small btn-approve" onclick="approve('{{ doc.doc_id }}')">âœ”ï¸ Approve</button>
                    {% else %}
                    <span class="text-muted">Archived</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="empty">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Result Modal -->
<div id="result-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">ê²°ê³¼</h3>
        <pre id="modal-body"></pre>
        <div id="modal-buttons" style="display:none;margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;"></div>
    </div>
</div>

<script>
    async function apiCall(endpoint, method = 'POST') {
        try {
            const res = await fetch(endpoint, { method });
            const data = await res.json();
            return { ok: res.ok, data };
        } catch (e) {
            return { ok: false, data: { error: e.message } };
        }
    }

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = '';
        btnArea.style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-buttons').innerHTML = '';
        document.getElementById('modal-buttons').style.display = 'none';
    }

    async function extractText(docId) {
        const { ok, data } = await apiCall(`/api/doc/${docId}/extract-text`);
        if (ok) {
            showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ', `ì¶”ì¶œëœ ë¬¸ì: ${data.chars}ì\n\në¯¸ë¦¬ë³´ê¸°:\n${data.preview}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function formatSections(details) {
        if (!details) return '';
        return Object.entries(details).map(([name, text]) => {
            const preview = text.length >= 300 ? text + '...' : text;
            return `ã€${name}ã€‘\n${preview}`;
        }).join('\n\n');
    }

    async function manualize(docId, force = false) {
        if (!force) {
            showModal('í™•ì¸ ì¤‘...', 'ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° í™•ì¸ ì¤‘...');
        } else {
            showModal('ì²˜ë¦¬ ì¤‘...', 'LLMìœ¼ë¡œ ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
        }
        const url = force ? `/api/doc/${docId}/manualize?force=true` : `/api/doc/${docId}/manualize`;
        const { ok, data } = await apiCall(url);
        if (ok) {
            if (data.cached) {
                showConfirmModal(
                    'ì´ë¯¸ ë§¤ë‰´ì–¼í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                    `${formatSections(data.section_details)}`,
                    () => manualize(docId, true)
                );
            } else {
                showModal('ë§¤ë‰´ì–¼í™” ì™„ë£Œ',
                    `ì„¹ì…˜ ${data.sections.length}ê°œ ìƒì„± | LLM ì‚¬ìš©: ${data.llm_used}\n${formatSections(data.section_details)}`);
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    async function qualityGate(docId) {
        showModal('í’ˆì§ˆ ê²€ì‚¬ ì¤‘...', 'LLMê³¼ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ë§¤ë‰´ì–¼ í’ˆì§ˆì„ ê²€ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
        const { ok, data } = await apiCall(`/api/doc/${docId}/quality-gate`);
        if (ok) {
            showModal('í’ˆì§ˆ ê²Œì´íŠ¸ ì™„ë£Œ', `RED: ${data.red_count}, YELLOW: ${data.yellow_count}\n\nì´ìŠˆ:\n${JSON.stringify(data.issues, null, 2)}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    async function approve(docId) {
        const { ok, data } = await apiCall(`/api/doc/${docId}/approve`);
        if (ok) {
            showModal('ìŠ¹ì¸ ì™„ë£Œ', `ìƒíƒœ: ${data.status}\nì²­í¬ ìƒì„±: ${data.reindex.chunk_count}ê°œ`);
            location.reload();
        } else {
            showModal('ìŠ¹ì¸ ì‹¤íŒ¨', data.detail || data.error);
        }
    }

    function showConfirmModal(title, content, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ì·¨ì†Œ (ê¸°ì¡´ ìœ ì§€)</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-confirm-btn">ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” (LLM)</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => { closeModal(); onConfirm(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    // Close modal on outside click
    document.getElementById('result-modal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell button {
        margin: 2px;
    }

    .btn-extract {
        background: #6366f1;
    }

    .btn-manualize {
        background: #8b5cf6;
    }

    .btn-gate {
        background: #f59e0b;
    }

    .btn-approve {
        background: #10b981;
    }

    .text-muted {
        color: #9ca3af;
    }
</style>
{% endblock %}