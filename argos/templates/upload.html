{% extends "base.html" %}

{% block content %}
<section class="upload-section">
    <h2>ğŸ“¤ ë¬¸ì„œ ì—…ë¡œë“œ & ë§¤ë‰´ì–¼í™”</h2>

    <!-- Create Apartment -->
    <div class="card">
        <h3>ì•„íŒŒíŠ¸ ì¶”ê°€</h3>
        <form id="apt-form" hx-post="/api/apartments" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { this.reset(); location.reload(); }">
            <input type="text" name="apt_id" placeholder="ì•„íŒŒíŠ¸ ID (ì˜ˆ: APT001)" required>
            <input type="text" name="name" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„" required>
            <button type="submit">â• ì¶”ê°€</button>
        </form>
    </div>

    <!-- Upload Document -->
    <div class="card">
        <h3>ë¬¸ì„œ ì—…ë¡œë“œ</h3>
        <form id="upload-form" hx-post="/api/upload" hx-encoding="multipart/form-data" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) location.reload();">
            <select name="apt_id" required>
                <option value="">-- ì•„íŒŒíŠ¸ ì„ íƒ --</option>
                {% for apt in apartments %}
                <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
                {% endfor %}
            </select>
            <input type="file" name="file" accept=".docx,.pdf,.txt,.md" required>
            <button type="submit">ğŸ“ ì—…ë¡œë“œ</button>
        </form>
    </div>
</section>

<section class="doc-list">
    <h2>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ì•„íŒŒíŠ¸</th>
                <th>ë¬¸ì„œëª…</th>
                <th>ë²„ì „</th>
                <th>ìƒíƒœ</th>
                <th>ì—…ë¡œë“œì¼</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr class="status-{{ doc.status|lower }}" id="row-{{ doc.doc_id }}">
                <td>{{ doc.apt_name or doc.apt_id }}</td>
                <td>{{ doc.title }}</td>
                <td>v{{ doc.version }}</td>
                <td><span class="badge badge-{{ doc.status|lower }}">{{ doc.status }}</span></td>
                <td>{{ doc.created_at[:16] }}</td>
                <td class="actions-cell">
                    {% if doc.status != 'ARCHIVED' %}
                    <button class="btn-small btn-extract" onclick="extractText('{{ doc.doc_id }}')">ğŸ“„ Extract</button>
                    <button class="btn-small btn-manualize" onclick="manualize('{{ doc.doc_id }}')">ğŸ“
                        Manualize</button>
                    <button class="btn-small" style="background:#ec4899;color:white;" onclick="upgradeDraft('{{ doc.doc_id }}')">âœ¨ Upgrade</button>
                    <button class="btn-small" style="background:#3b82f6;color:white;" onclick="openEditor('{{ doc.doc_id }}')">âœï¸ Edit</button>
                    <button class="btn-small btn-gate" onclick="qualityGate('{{ doc.doc_id }}')">âœ… Gate</button>
                    <button class="btn-small btn-approve" onclick="approve('{{ doc.doc_id }}')">âœ”ï¸ Approve</button>
                    {% else %}
                    <span class="text-muted">Archived</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="empty">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Result Modal -->
<div id="result-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">ê²°ê³¼</h3>
        <pre id="modal-body"></pre>
        <div id="modal-buttons" style="display:none;margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;"></div>
    </div>
</div>

<!-- Editor Modal -->
<div id="editor-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <span class="close" onclick="closeEditor()">&times;</span>
        <h3>âœï¸ ë§¤ë‰´ì–¼ ì—ë””í„°</h3>
        <p class="text-muted" style="margin-bottom:1rem;">ë‚´ìš©ì„ ì§ì ‘ ìˆ˜ì •í•˜ê±°ë‚˜ AIì˜ ë„ì›€ì„ ë°›ì•„ ë³´ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div id="editor-container" style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Sections will be injected here -->
        </div>

        <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.5rem; border-top: 1px solid #eee; padding-top: 1rem;">
            <button class="btn" style="background:#9ca3af;" onclick="closeEditor()">ì·¨ì†Œ</button>
            <button class="btn" style="background:#f59e0b;" onclick="revalidateEditor()">ğŸ” AI ì¬ê²€ì¦ (Gate)</button>
            <button id="save-editor-btn" class="btn" onclick="saveEditor()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentDocId = null;

    async function upgradeDraft(docId) {
        showModal('AI ê°€ë‹¤ë“¬ê¸° ì¤‘...', 'AIê°€ ë§¤ë‰´ì–¼ ì´ˆì•ˆì„ ë” ì „ë¬¸ì ìœ¼ë¡œ ê°€ë‹¤ë“¬ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
        const res = await fetch(`/api/doc/${docId}/upgrade-draft`, { method: 'POST' });
        const data = await res.json();
        
        if (res.ok) {
            const htmlText = `âœ¨ AI ê°€ë‹¤ë“¬ê¸° ì™„ë£Œ\n\n[ê°œì„  ìš”ì•½]\n${data.change_summary}\n\n[ì¶”ê°€ í™•ì¸ í•„ìš” ì‚¬í•­]\n${data.todo_questions.map(q => `- ${q}`).join('\n')}\n\nì—ë””í„°ë¥¼ ì—´ì–´ ë‚´ìš©ì„ í™•ì¸í•´ ë³´ì„¸ìš”.`;
            showModal('ê°€ë‹¤ë“¬ê¸° ì™„ë£Œ', htmlText);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    async function openEditor(docId) {
        currentDocId = docId;
        const res = await fetch(`/api/doc/${docId}/sections`);
        const sections = await res.json();
        
        const container = document.getElementById('editor-container');
        container.innerHTML = '';
        
        sections.forEach(sec => {
            const secDiv = document.createElement('div');
            secDiv.className = 'card';
            secDiv.style.margin = '0';
            secDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong>${sec.section_name}</strong>
                    <div style="display:flex; gap:0.25rem;">
                        <button class="btn-small" style="background:#6366f1;color:white;" onclick="aiRefine('${sec.section_name}', 'refine')">ğŸª„ ë‹¤ë“¬ê¸°</button>
                        <button class="btn-small" style="background:#10b981;color:white;" onclick="aiRefine('${sec.section_name}', 'fill')">â• ë³´ê°•</button>
                        <button class="btn-small" style="background:#8b5cf6;color:white;" onclick="aiRefine('${sec.section_name}', 'recommend')">ğŸ’¡ ì¶”ì²œ</button>
                    </div>
                </div>
                <textarea id="editor-${sec.section_name}" style="width:100%; height:150px; padding:10px; border-radius:6px; border:1px solid #d1d5db; font-family:inherit; font-size:14px; resize:vertical;">${sec.section_text}</textarea>
            `;
            container.appendChild(secDiv);
        });

        document.getElementById('editor-modal').style.display = 'flex';
    }

    function closeEditor() {
        document.getElementById('editor-modal').style.display = 'none';
    }

    async function aiRefine(sectionName, task) {
        const textarea = document.getElementById(`editor-${sectionName}`);
        const currentText = textarea.value;
        
        const originalText = textarea.value;
        textarea.value = "AIê°€ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...";
        textarea.disabled = true;

        const res = await fetch(`/api/doc/${currentDocId}/refine-text`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: currentText, task: task, context: sectionName })
        });
        const result = await res.json();
        
        textarea.disabled = false;
        if (res.ok) {
            if (confirm(`AI ì œì•ˆì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n[ì œì•ˆ ë‚´ìš©]\n${result.suggestion}`)) {
                textarea.value = result.suggestion;
            } else {
                textarea.value = originalText;
            }
        } else {
            alert(result.detail || "AI ìš”ì²­ ì‹¤íŒ¨");
            textarea.value = originalText;
        }
    }

    async function saveEditor() {
        const container = document.getElementById('editor-container');
        const textareas = container.querySelectorAll('textarea');
        const sections = {};
        textareas.forEach(ta => {
            const name = ta.id.replace('editor-', '');
            sections[name] = ta.value;
        });

        const res = await fetch(`/api/doc/${currentDocId}/sections`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sections })
        });

        if (res.ok) {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            const data = await res.json();
            alert("ì €ì¥ ì‹¤íŒ¨: " + (data.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
    }

    async function revalidateEditor() {
        await saveEditor();
        qualityGate(currentDocId);
    }
    async function apiCall(endpoint, method = 'POST') {
        try {
            const res = await fetch(endpoint, { method });
            const data = await res.json();
            return { ok: res.ok, data };
        } catch (e) {
            return { ok: false, data: { error: e.message } };
        }
    }

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = '';
        btnArea.style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-buttons').innerHTML = '';
        document.getElementById('modal-buttons').style.display = 'none';
    }

    async function extractText(docId) {
        const { ok, data } = await apiCall(`/api/doc/${docId}/extract-text`);
        if (ok) {
            showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ', `ì¶”ì¶œëœ ë¬¸ì: ${data.chars}ì\n\në¯¸ë¦¬ë³´ê¸°:\n${data.preview}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function formatSections(details) {
        if (!details) return '';
        return Object.entries(details).map(([name, text]) => {
            const preview = text.length >= 300 ? text + '...' : text;
            return `ã€${name}ã€‘\n${preview}`;
        }).join('\n\n');
    }

    async function manualize(docId, force = false) {
        if (!force) {
            showModal('í™•ì¸ ì¤‘...', 'ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° í™•ì¸ ì¤‘...');
        } else {
            showModal('ì²˜ë¦¬ ì¤‘...', 'LLMìœ¼ë¡œ ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
        }
        const url = force ? `/api/doc/${docId}/manualize?force=true` : `/api/doc/${docId}/manualize`;
        const { ok, data } = await apiCall(url);
        if (ok) {
            if (data.cached) {
                showConfirmModal(
                    'ì´ë¯¸ ë§¤ë‰´ì–¼í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                    `${formatSections(data.section_details)}`,
                    () => manualize(docId, true)
                );
            } else {
                let msg = `ì„¹ì…˜ ${data.sections.length}ê°œ ìƒì„± | LLM ì‚¬ìš©: ${data.llm_used}`;
                if (data.llm_error) {
                    msg += `\nâš ï¸ LLM ì˜¤ë¥˜: ${data.llm_error}\n(ê·œì¹™ ê¸°ë°˜ Fallbackì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.)`;
                }
                showModal('ë§¤ë‰´ì–¼í™” ì™„ë£Œ',
                    `${msg}\n\n${formatSections(data.section_details)}`);
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    async function qualityGate(docId) {
        showModal('í’ˆì§ˆ ê²€ì‚¬ ì¤‘...', 'LLMê³¼ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ë§¤ë‰´ì–¼ í’ˆì§ˆì„ ê²€ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
        const { ok, data } = await apiCall(`/api/doc/${docId}/quality-gate`);
        if (ok) {
            let msg = `RED: ${data.red_count}, YELLOW: ${data.yellow_count}`;
            if (data.llm_error) {
                msg += `\nâš ï¸ LLM ì˜¤ë¥˜: ${data.llm_error}\n(ê·œì¹™ ê¸°ë°˜ ê²€ì‚¬ ê²°ê³¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤.)`;
            }
            showModal('í’ˆì§ˆ ê²Œì´íŠ¸ ì™„ë£Œ', `${msg}\n\nì´ìŠˆ:\n${JSON.stringify(data.issues, null, 2)}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    async function approve(docId) {
        const { ok, data } = await apiCall(`/api/doc/${docId}/approve`);
        if (ok) {
            showModal('ìŠ¹ì¸ ì™„ë£Œ', `ìƒíƒœ: ${data.status}\nì²­í¬ ìƒì„±: ${data.reindex.chunk_count}ê°œ`);
            location.reload();
        } else {
            showModal('ìŠ¹ì¸ ì‹¤íŒ¨', data.detail || data.error);
        }
    }

    function showConfirmModal(title, content, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ì·¨ì†Œ (ê¸°ì¡´ ìœ ì§€)</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-confirm-btn">ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” (LLM)</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => { closeModal(); onConfirm(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    // Close modal on outside click
    document.getElementById('result-modal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell button {
        margin: 2px;
    }

    .btn-extract {
        background: #6366f1;
    }

    .btn-manualize {
        background: #8b5cf6;
    }

    .btn-gate {
        background: #f59e0b;
    }

    .btn-approve {
        background: #10b981;
    }

    .text-muted {
        color: #9ca3af;
    }
</style>
{% endblock %}