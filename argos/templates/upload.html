{% extends "base.html" %}

{% block content %}
<section class="upload-section">
    <h2>ğŸ“¤ ë¬¸ì„œ ì—…ë¡œë“œ & ë§¤ë‰´ì–¼í™”</h2>

    <!-- Create Apartment -->
    <div class="card">
        <h3>ì•„íŒŒíŠ¸ ì¶”ê°€</h3>
        <form id="apt-form" hx-post="/api/apartments" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { this.reset(); location.reload(); }">
            <input type="text" name="apt_id" placeholder="ì•„íŒŒíŠ¸ ID (ì˜ˆ: APT001)" required>
            <input type="text" name="name" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„" required>
            <button type="submit">â• ì¶”ê°€</button>
        </form>
    </div>

    <!-- Upload Document -->
    <div class="card">
        <h3>ë¬¸ì„œ ì—…ë¡œë“œ</h3>
        <form id="upload-form" hx-post="/api/upload" hx-encoding="multipart/form-data" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) location.reload();">
            <select name="apt_id" required>
                <option value="">-- ì•„íŒŒíŠ¸ ì„ íƒ --</option>
                {% for apt in apartments %}
                <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
                {% endfor %}
            </select>
            <input type="file" name="file" accept=".docx,.pdf,.txt,.md" required>
            <button type="submit">ğŸ“ ì—…ë¡œë“œ</button>
        </form>
    </div>
</section>

<section class="doc-list">
    <h2>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ì•„íŒŒíŠ¸</th>
                <th>ë¬¸ì„œëª…</th>
                <th>ë²„ì „</th>
                <th>ìƒíƒœ</th>
                <th>ì—…ë¡œë“œì¼</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr class="status-{{ doc.status|lower }}" id="row-{{ doc.doc_id }}">
                <td>{{ doc.apt_name or doc.apt_id }}</td>
                <td>{{ doc.title }}</td>
                <td>v{{ doc.version }}</td>
                <td><span class="badge badge-{{ doc.status|lower }}">{{ doc.status }}</span></td>
                <td>{{ doc.created_at[:16] }}</td>
                <td class="actions-cell">
                    {% if doc.status != 'ARCHIVED' %}
                    <button class="btn-small btn-extract" onclick="extractText('{{ doc.doc_id }}')">ğŸ“„ Extract</button>
                    {% if doc.has_manual %}
                    <button class="btn-small btn-view-manual" onclick="openEditor('{{ doc.doc_id }}')">ğŸ“– ë§¤ë‰´ì–¼
                        ë³´ê¸°</button>
                    {% else %}
                    <button class="btn-small btn-manualize" onclick="manualize('{{ doc.doc_id }}')">ğŸ“
                        Manualize</button>
                    {% endif %}
                    <button class="btn-small btn-gate" onclick="qualityGate('{{ doc.doc_id }}')">âœ… Gate</button>
                    <button class="btn-small btn-approve" id="approve-btn-{{ doc.doc_id }}"
                        onclick="approve('{{ doc.doc_id }}')">âš™ï¸ RAG ë°ì´í„°í™”</button>
                    {% else %}
                    <span class="text-muted">Archived</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="empty">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Result Modal -->
<div id="result-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">ê²°ê³¼</h3>
        <pre id="modal-body"></pre>
        <div id="modal-buttons" style="display:none;margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;">
        </div>
    </div>
</div>

<!-- Editor Modal -->
<div id="editor-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <span class="close" onclick="closeEditor()">&times;</span>
        <h3>âœï¸ ë§¤ë‰´ì–¼ ì—ë””í„°</h3>
        <p class="text-muted" style="margin-bottom:1rem;">ë‚´ìš©ì„ ì§ì ‘ ìˆ˜ì •í•˜ê±°ë‚˜ AIì˜ ë„ì›€ì„ ë°›ì•„ ë³´ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div id="editor-container" style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Sections will be injected here -->
        </div>

        <div
            style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.5rem; border-top: 1px solid #eee; padding-top: 1rem;">
            <button class="btn" style="background:#9ca3af;" onclick="closeEditor()">ì·¨ì†Œ</button>
            <button class="btn" style="background:#f59e0b;" onclick="revalidateEditor()">ğŸ” AI ì¬ê²€ì¦ (Gate)</button>
            <button id="save-editor-btn" class="btn" onclick="saveEditor()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div id="compare-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 1100px; width: 95%;">
        <span class="close" onclick="closeCompare()">&times;</span>
        <h3 id="compare-title">ğŸ”„ AI ì œì•ˆ ë¹„êµ</h3>
        <p class="text-muted" style="margin-bottom:1rem;">ì™¼ìª½ì´ í˜„ì¬ ë‚´ìš©, ì˜¤ë¥¸ìª½ì´ AI ì œì•ˆì…ë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì„ ìˆ˜ì •í•œ ë’¤ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="compare-container">
            <div class="compare-panel">
                <div class="compare-label">ğŸ“„ í˜„ì¬ (Before)</div>
                <div id="compare-before" class="compare-text"></div>
            </div>
            <div class="compare-panel">
                <div class="compare-label">âœ¨ AI ì œì•ˆ (After)</div>
                <textarea id="compare-after" class="compare-textarea"></textarea>
            </div>
        </div>
        <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn" style="background:#9ca3af;" onclick="closeCompare()">âŒ ì·¨ì†Œ (ì›ë˜ ìœ ì§€)</button>
            <button class="btn" style="background:#3b82f6;" onclick="applyCompare()">âœ… ì ìš©í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentDocId = null;

    async function manualize(docId, force = false) {
        currentDocId = docId;
        if (!force) {
            showModal('í™•ì¸ ì¤‘...', 'ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° í™•ì¸ ì¤‘...');
        } else {
            showModal('AI ë¶„ì„ ì¤‘...', `
                <div style="text-align:center; padding: 1rem;">
                    <div class="spinner"></div>
                    <p><strong>AIê°€ ë¬¸ì„œë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ë§¤ë‰´ì–¼ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.</strong></p>
                    <p style="font-size:0.85rem; color:#6b7280; margin-top:0.5rem;">
                        ë¬¸ì„œì˜ ì–‘ì— ë”°ë¼ 10~30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì—ë””í„°ê°€ ì—´ë¦½ë‹ˆë‹¤.
                    </p>
                </div>
            `);
        }

        const url = force ? `/api/doc/${docId}/manualize?force=true` : `/api/doc/${docId}/manualize`;
        const { ok, data } = await apiCall(url);

        if (ok) {
            if (data.cached && !force) {
                showConfirmModalForCache(
                    'ì´ë¯¸ ë§¤ë‰´ì–¼í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                    `ì´ë¯¸ ìƒì„±ëœ ì„¹ì…˜(${data.sections.length}ê°œ)ì´ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    () => openEditorWithData(docId, data),
                    () => manualize(docId, true)
                );
            } else {
                openEditorWithData(docId, data);
                closeModal();
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function showConfirmModalForCache(title, content, onOpenEditor, onManualizeAgain) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn-small" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-edit-btn">âœï¸ ì—ë””í„° ì—´ê¸°</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-again-btn">âœ¨ AI ë‹¤ì‹œ ë¶„ì„</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-edit-btn').onclick = () => { closeModal(); onOpenEditor(); };
        document.getElementById('modal-again-btn').onclick = () => { closeModal(); onManualizeAgain(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    function openEditorWithData(docId, data) {
        currentDocId = docId;
        const container = document.getElementById('editor-container');
        container.innerHTML = '';

        // Add LLM Error if any
        if (data.llm_error) {
            const errDiv = document.createElement('div');
            errDiv.className = 'info';
            errDiv.style.background = '#fef2f2';
            errDiv.style.color = '#991b1b';
            errDiv.style.border = '1px solid #fecaca';
            errDiv.style.marginBottom = '1rem';
            errDiv.innerHTML = `<strong>âš ï¸ LLM ì‚¬ìš© ë¶ˆê°€: ${data.llm_error}</strong><br><small>ê·œì¹™ ê¸°ë°˜ ì•Œê³ ë¹„ì¦˜ìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.</small>`;
            container.appendChild(errDiv);
        }

        // Add Change Summary if any
        if (data.change_summary) {
            const sumDiv = document.createElement('div');
            sumDiv.className = 'info';
            sumDiv.style.background = '#f0fdf4';
            sumDiv.style.color = '#166534';
            sumDiv.style.border = '1px solid #bbf7d0';
            sumDiv.style.marginBottom = '1rem';
            sumDiv.innerHTML = `<strong>âœ¨ AI ë¶„ì„ ìš”ì•½</strong><br>${data.change_summary}`;
            container.appendChild(sumDiv);
        }

        if (data.todo_questions && data.todo_questions.length > 0) {
            const todoDiv = document.createElement('div');
            todoDiv.className = 'info';
            todoDiv.style.marginBottom = '1rem';
            todoDiv.innerHTML = `<strong>ğŸ“Œ AI ë³´ê°• ìš”ì²­ì‚¬í•­</strong><ul style="margin-left:1.5rem;margin-top:0.5rem;">${data.todo_questions.map(q => `<li>${q}</li>`).join('')}</ul>`;
            container.appendChild(todoDiv);
        }

        let sectionIndex = 0;
        Object.entries(data.section_details).forEach(([name, text]) => {
            const idx = sectionIndex++;
            const secDiv = document.createElement('div');
            secDiv.className = 'card';
            secDiv.style.margin = '0';
            secDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong>${name}</strong>
                    <div style="display:flex; gap:0.25rem;">
                        <button class="btn-small" style="background:#6366f1;color:white;" onclick="aiRefine(${idx}, 'refine')">ğŸª„ RAG ìµœì í™”</button>
                        <button class="btn-small" style="background:#10b981;color:white;" onclick="aiRefine(${idx}, 'fill')">â• ë§¥ë½ ë³´ê°•</button>
                    </div>
                </div>
                <textarea id="editor-${idx}" class="editor-textarea" data-section-name="${name.replace(/"/g, '&quot;')}" oninput="autoResize(this)">${text}</textarea>
            `;
            container.appendChild(secDiv);
        });

        document.getElementById('editor-modal').style.display = 'flex';

        // Auto-resize all textareas after rendering
        requestAnimationFrame(() => {
            container.querySelectorAll('.editor-textarea').forEach(ta => autoResize(ta));
        });
    }

    async function openEditor(docId) {
        const res = await fetch(`/api/doc/${docId}/sections`);
        const sections = await res.json();
        const details = {};
        sections.forEach(s => details[s.section_name] = s.section_text);
        openEditorWithData(docId, { section_details: details, todo_questions: [] });
    }

    async function qualityGate(docId) {
        showModal('í’ˆì§ˆ ê²€ì‚¬ ë° API ì¶”ì¶œ ì¤‘...', 'ë§¤ë‰´ì–¼ í’ˆì§ˆì„ ê²€ì¦í•˜ê³  ì‹œìŠ¤í…œ ì—°ë™ì„ ìœ„í•œ API ìŠ¤í™ì„ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
        const { ok, data } = await apiCall(`/api/doc/${docId}/quality-gate`);
        if (ok) {
            let apiHtml = '';
            if (data.api_specs && data.api_specs.length > 0) {
                apiHtml = `\n\n[ì¶”ì¶œëœ API ëª©ë¡]\n` + data.api_specs.map(s => `- ${s.intent}: ${s.method} ${s.endpoint}`).join('\n');
            }
            showModal('ê²€ì¦ ë° ì¶”ì¶œ ì™„ë£Œ', `RED: ${data.red_count}, YELLOW: ${data.yellow_count}\n\nì´ìŠˆ:\n${JSON.stringify(data.issues, null, 2)}${apiHtml}`);

            const approveBtn = document.getElementById(`approve-btn-${docId}`);
            if (approveBtn) {
                approveBtn.disabled = data.red_count > 0;
                if (data.red_count > 0) {
                    approveBtn.style.opacity = '0.5';
                    approveBtn.title = "RED ì´ìŠˆë¥¼ í•´ê²°í•´ì•¼ RAG ë°ì´í„°í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                } else {
                    approveBtn.style.opacity = '1';
                    approveBtn.title = "";
                }
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function closeEditor() {
        document.getElementById('editor-modal').style.display = 'none';
    }

    let compareTargetIdx = null;

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    async function aiRefine(idx, task) {
        const textarea = document.getElementById(`editor-${idx}`);
        const sectionName = textarea.dataset.sectionName;
        const originalText = textarea.value;
        textarea.value = "AIê°€ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...";
        textarea.disabled = true;
        autoResize(textarea);

        const res = await fetch(`/api/doc/${currentDocId}/refine-text`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: originalText, task: task, context: sectionName })
        });
        const result = await res.json();

        textarea.disabled = false;
        textarea.value = originalText;
        autoResize(textarea);

        if (res.ok) {
            openCompare(idx, sectionName, originalText, result.suggestion, task);
        } else {
            alert(result.detail || "AI ìš”ì²­ ì‹¤íŒ¨");
        }
    }

    function openCompare(idx, sectionName, before, after, task) {
        compareTargetIdx = idx;
        const taskLabel = task === 'refine' ? 'ğŸª„ RAG ìµœì í™”' : 'â• ë§¥ë½ ë³´ê°•';
        document.getElementById('compare-title').textContent = `ğŸ”„ ${taskLabel} ë¹„êµ â€” ${sectionName}`;
        document.getElementById('compare-before').textContent = before;
        const afterTA = document.getElementById('compare-after');
        afterTA.value = after;
        document.getElementById('compare-modal').style.display = 'flex';
        requestAnimationFrame(() => {
            afterTA.style.height = 'auto';
            afterTA.style.height = afterTA.scrollHeight + 'px';
        });
    }

    function closeCompare() {
        document.getElementById('compare-modal').style.display = 'none';
        compareTargetIdx = null;
    }

    function applyCompare() {
        if (compareTargetIdx === null) return;
        const textarea = document.getElementById(`editor-${compareTargetIdx}`);
        textarea.value = document.getElementById('compare-after').value;
        autoResize(textarea);
        closeCompare();
    }

    async function saveEditor() {
        const container = document.getElementById('editor-container');
        const textareas = container.querySelectorAll('textarea.editor-textarea');
        const sections = {};
        textareas.forEach(ta => {
            const name = ta.dataset.sectionName;
            if (name) sections[name] = ta.value;
        });

        const res = await fetch(`/api/doc/${currentDocId}/sections`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sections })
        });

        if (res.ok) {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            const data = await res.json();
            alert("ì €ì¥ ì‹¤íŒ¨: " + (data.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
    }

    async function revalidateEditor() {
        await saveEditor();
        qualityGate(currentDocId);
    }

    async function apiCall(endpoint, method = 'POST') {
        try {
            const res = await fetch(endpoint, { method });
            const data = await res.json();
            return { ok: res.ok, data };
        } catch (e) {
            return { ok: false, data: { error: e.message } };
        }
    }

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        const body = document.getElementById('modal-body');
        if (typeof content === 'string' && content.includes('<div')) {
            body.innerHTML = content;
        } else {
            body.innerHTML = `<pre style="background:#f5f5f5;padding:1rem;border-radius:4px;white-space:pre-wrap;word-break:break-word;">${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}</pre>`;
        }
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = '';
        btnArea.style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-buttons').innerHTML = '';
        document.getElementById('modal-buttons').style.display = 'none';
    }

    async function extractText(docId) {
        showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...', '<div style="text-align:center;"><div class="spinner"></div>ë¬¸ì„œì—ì„œ ë‚´ìš©ì„ ì½ì–´ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/extract-text`);
        if (ok) {
            showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ', `ì¶”ì¶œëœ ë¬¸ì: ${data.chars}ì\n\në¯¸ë¦¬ë³´ê¸°:\n${data.preview}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function formatSections(details) {
        if (!details) return '';
        return Object.entries(details).map(([name, text]) => {
            const preview = text.length >= 300 ? text + '...' : text;
            return `ã€${name}ã€‘\n${preview}`;
        }).join('\n\n');
    }

    async function approve(docId) {
        showModal('RAG ë°ì´í„°í™” ì¤‘...', '<div style="text-align:center;"><div class="spinner"></div>ë¬¸ì„œë¥¼ ìŠ¹ì¸í•˜ê³  ê²€ìƒ‰ ì¸ë±ìŠ¤ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/approve`);
        if (ok) {
            showModal('RAG ë°ì´í„°í™” ì™„ë£Œ', `ìƒíƒœ: ${data.status}\nì²­í¬ ìƒì„±: ${data.reindex.chunk_count}ê°œ\nì´ì œ ì±—ë´‡ì—ì„œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            location.reload();
        } else {
            showModal('ì‹¤íŒ¨', data.detail || data.error);
        }
    }

    function showConfirmModal(title, content, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ì·¨ì†Œ (ê¸°ì¡´ ìœ ì§€)</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-confirm-btn">ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” (LLM)</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => { closeModal(); onConfirm(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    // Close modal on outside click
    document.getElementById('result-modal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell button {
        margin: 2px;
    }

    .btn-extract {
        background: #6366f1;
    }

    .btn-manualize {
        background: #8b5cf6;
    }

    .btn-view-manual {
        background: #3b82f6;
    }

    .btn-gate {
        background: #f59e0b;
    }

    .btn-approve {
        background: #10b981;
    }

    .text-muted {
        color: #9ca3af;
    }

    /* Auto-expand textareas */
    .editor-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        overflow: hidden;
        line-height: 1.6;
        box-sizing: border-box;
    }

    /* Comparison modal styles */
    .compare-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .compare-panel {
        display: flex;
        flex-direction: column;
    }

    .compare-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        padding: 6px 12px;
        border-radius: 6px 6px 0 0;
    }

    .compare-panel:first-child .compare-label {
        background: #fef2f2;
        color: #991b1b;
    }

    .compare-panel:last-child .compare-label {
        background: #f0fdf4;
        color: #166534;
    }

    .compare-text {
        background: #fafafa;
        border: 1px solid #e5e7eb;
        border-radius: 0 0 6px 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        flex: 1;
        color: #374151;
        min-height: 350px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .compare-textarea {
        border: 1px solid #86efac;
        border-radius: 0 0 6px 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.6;
        font-family: inherit;
        resize: vertical;
        min-height: 350px;
        max-height: 60vh;
        flex: 1;
        box-sizing: border-box;
    }

    .compare-textarea:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
    }

    @media (max-width: 768px) {
        .compare-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}