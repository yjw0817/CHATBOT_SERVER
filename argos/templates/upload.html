{% extends "base.html" %}

{% block content %}
<section class="upload-section">
    <h2>ğŸ“¤ ë¬¸ì„œ ì—…ë¡œë“œ & ë§¤ë‰´ì–¼í™”</h2>

    <!-- Create Apartment -->
    <div class="card">
        <h3>ì•„íŒŒíŠ¸ ì¶”ê°€</h3>
        <form id="apt-form" hx-post="/api/apartments" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) { this.reset(); location.reload(); }">
            <input type="text" name="apt_id" placeholder="ì•„íŒŒíŠ¸ ID (ì˜ˆ: APT001)" required>
            <input type="text" name="name" placeholder="ì•„íŒŒíŠ¸ ì´ë¦„" required>
            <button type="submit">â• ì¶”ê°€</button>
        </form>
    </div>

    <!-- Apartment List -->
    <div class="card">
        <h3>ë“±ë¡ëœ ì•„íŒŒíŠ¸</h3>
        {% if apartments %}
        <ul style="list-style:none;padding:0;margin:0;">
            {% for apt in apartments %}
            <li style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee;">
                <span>{{ apt.name }} ({{ apt.apt_id }})</span>
                <button class="btn-small" style="background:#f87171;color:white;" onclick="deleteApartment('{{ apt.apt_id }}', '{{ apt.name }}')">ğŸ—‘ï¸ ì‚­ì œ</button>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">ë“±ë¡ëœ ì•„íŒŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

    <!-- Upload Document -->
    <div class="card">
        <h3>ë¬¸ì„œ ì—…ë¡œë“œ</h3>
        <form id="upload-form" hx-post="/api/upload" hx-encoding="multipart/form-data" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) location.reload();">
            <select name="apt_id" required>
                <option value="">-- ì•„íŒŒíŠ¸ ì„ íƒ --</option>
                {% for apt in apartments %}
                <option value="{{ apt.apt_id }}">{{ apt.name }} ({{ apt.apt_id }})</option>
                {% endfor %}
            </select>
            <input type="file" name="file" accept=".docx,.pdf,.txt,.md" required>
            <button type="submit">ğŸ“ ì—…ë¡œë“œ</button>
        </form>
    </div>
</section>

<section class="doc-list">
    <h2>ğŸ“‹ ë¬¸ì„œ ëª©ë¡</h2>
    <table>
        <thead>
            <tr>
                <th>ì•„íŒŒíŠ¸</th>
                <th>ë¬¸ì„œëª…</th>
                <th>ë²„ì „</th>
                <th>ìƒíƒœ</th>
                <th>ì—…ë¡œë“œì¼</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr class="status-{{ doc.status|lower }}" id="row-{{ doc.doc_id }}">
                <td>{{ doc.apt_name or doc.apt_id }}</td>
                <td>{{ doc.title }}</td>
                <td>v{{ doc.version }}</td>
                <td><span class="badge badge-{{ doc.status|lower }}">{{ doc.status }}</span></td>
                <td>{{ doc.created_at[:16] }}</td>
                <td class="actions-cell">
                    {% if doc.status != 'ARCHIVED' %}
                    <button class="btn-small btn-extract" onclick="extractText('{{ doc.doc_id }}')">ğŸ“„ Extract</button>
                    {% if doc.has_manual %}
                    <button class="btn-small btn-view-manual" onclick="openEditor('{{ doc.doc_id }}')">ğŸ“– ë§¤ë‰´ì–¼
                        ë³´ê¸°</button>
                    {% else %}
                    <button class="btn-small btn-manualize" onclick="manualize('{{ doc.doc_id }}')">ğŸ“
                        Manualize</button>
                    {% endif %}
                    <button class="btn-small btn-gate" onclick="qualityGate('{{ doc.doc_id }}')">âœ… Gate</button>
                    <button class="btn-small btn-approve" id="approve-btn-{{ doc.doc_id }}"
                        onclick="approve('{{ doc.doc_id }}')">âš™ï¸ RAG ë°ì´í„°í™”</button>
                    <button class="btn-small" style="background:#f87171;color:white;" onclick="deleteDocument('{{ doc.doc_id }}', '{{ doc.title }}')">ğŸ—‘ï¸</button>
                    {% else %}
                    <span class="text-muted">Archived</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="empty">ì—…ë¡œë“œëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Result Modal -->
<div id="result-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">ê²°ê³¼</h3>
        <pre id="modal-body"></pre>
        <div id="modal-buttons" style="display:none;margin-top:1rem;display:flex;gap:0.5rem;justify-content:flex-end;">
        </div>
    </div>
</div>

<!-- Editor Modal -->
<div id="editor-modal" class="modal" style="display:none;">
    <div class="modal-content editor-modal-content" style="max-width: 1200px; width: 95%;">
        <div class="editor-header">
            <span class="close" onclick="closeEditor()">&times;</span>
            <h3>âœï¸ ë§¤ë‰´ì–¼ ì—ë””í„°</h3>
            <p class="text-muted">ë‚´ìš©ì„ ì§ì ‘ ìˆ˜ì •í•˜ê±°ë‚˜ AIì˜ ë„ì›€ì„ ë°›ì•„ ë³´ê°•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div id="editor-container" class="editor-body">
            <!-- Sections will be injected here -->
        </div>

        <div class="editor-footer">
            <button class="btn" style="background:#9ca3af;" onclick="closeEditor()">ì·¨ì†Œ</button>
            <button class="btn" style="background:#f59e0b;" onclick="closeEditor(); manualize(currentDocId, true)">ğŸ”„ ë‹¤ì‹œ
                Manualize</button>
            <button id="btn-bulk-fill" class="btn" style="background:#d97706;" onclick="bulkFillNeedFix()">ğŸ”§ NEED_FIX ì¼ê´„ ë³´ê°•</button>
            <button id="save-editor-btn" class="btn" onclick="saveEditor()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div id="compare-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 1100px; width: 95%;">
        <span class="close" onclick="closeCompare()">&times;</span>
        <h3 id="compare-title">ğŸ”„ AI ì œì•ˆ ë¹„êµ</h3>
        <p class="text-muted" style="margin-bottom:1rem;">ì™¼ìª½ì´ í˜„ì¬ ë‚´ìš©, ì˜¤ë¥¸ìª½ì´ AI ì œì•ˆì…ë‹ˆë‹¤. ì˜¤ë¥¸ìª½ì„ ìˆ˜ì •í•œ ë’¤ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="compare-container">
            <div class="compare-panel">
                <div class="compare-label">ğŸ“„ í˜„ì¬ (Before)</div>
                <div id="compare-before" class="compare-text"></div>
            </div>
            <div class="compare-panel">
                <div class="compare-label">âœ¨ AI ì œì•ˆ (After)</div>
                <textarea id="compare-after" class="compare-textarea"></textarea>
            </div>
        </div>
        <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn" style="background:#9ca3af;" onclick="closeCompare()">âŒ ì·¨ì†Œ (ì›ë˜ ìœ ì§€)</button>
            <button class="btn" style="background:#6b7280;" onclick="applyCompareSaveOnly()">âœ… ì ìš©(ì €ì¥)</button>
            <button class="btn" style="background:#3b82f6;" onclick="applyCompareSaveAndGate()">âœ… ì ìš© + Gate ì¬ê²€ì¦</button>
        </div>
    </div>
</div>

<script>
    let currentDocId = null;

    async function manualize(docId, force = false) {
        currentDocId = docId;
        if (!force) {
            showModal('í™•ì¸ ì¤‘...', 'ê¸°ì¡´ ë§¤ë‰´ì–¼ ë°ì´í„° í™•ì¸ ì¤‘...');
        } else {
            showModal('AI ë¶„ì„ ì¤‘...', `
                <div style="text-align:center; padding: 1rem;">
                    <div class="spinner"></div>
                    <p><strong>AIê°€ ë¬¸ì„œë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ë§¤ë‰´ì–¼ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.</strong></p>
                    <p style="font-size:0.85rem; color:#6b7280; margin-top:0.5rem;">
                        ë¬¸ì„œì˜ ì–‘ì— ë”°ë¼ 10~30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì—ë””í„°ê°€ ì—´ë¦½ë‹ˆë‹¤.
                    </p>
                </div>
            `);
        }

        const url = force ? `/api/doc/${docId}/manualize?force=true` : `/api/doc/${docId}/manualize`;
        const { ok, data } = await apiCall(url);

        if (ok) {
            if (data.cached && !force) {
                showConfirmModalForCache(
                    'ì´ë¯¸ ë§¤ë‰´ì–¼í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                    `ì´ë¯¸ ìƒì„±ëœ ì„¹ì…˜(${data.sections.length}ê°œ)ì´ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    () => openEditorWithData(docId, data),
                    () => manualize(docId, true)
                );
            } else {
                openEditorWithData(docId, data);
                closeModal();
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function showConfirmModalForCache(title, content, onOpenEditor, onManualizeAgain) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ë‹«ê¸°</button>
            <button class="btn-small" style="background:#3b82f6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-edit-btn">âœï¸ ì—ë””í„° ì—´ê¸°</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-again-btn">âœ¨ AI ë‹¤ì‹œ ë¶„ì„</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-edit-btn').onclick = () => { closeModal(); onOpenEditor(); };
        document.getElementById('modal-again-btn').onclick = () => { closeModal(); onManualizeAgain(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    function _gateBadgeHTML(status) {
        if (!status) return '';
        const badges = {
            'PASS': '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:6px;">âœ… PASS</span>',
            'NEED_FIX': '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:6px;">ğŸ”§ NEED_FIX</span>',
            'BLOCK': '<span style="background:#fef2f2;color:#991b1b;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:6px;">â›” BLOCK</span>'
        };
        return badges[status] || '';
    }

    function _gateHintHTML(status) {
        if (!status) return '';
        const hints = {
            'PASS': '<div style="font-size:12px;color:#166534;margin-bottom:6px;">âœ… RAG ë°˜ì˜ ê°€ëŠ¥ (PASS)</div>',
            'NEED_FIX': '<div style="font-size:12px;color:#92400e;margin-bottom:6px;">ğŸ”§ Fill ë³´ê°• â†’ Gate ì¬ê²€ì¦ í•„ìš”</div>',
            'BLOCK': '<div style="font-size:12px;color:#991b1b;margin-bottom:6px;">â›” ìˆ˜ë™ ìˆ˜ì • í•„ìš” (BLOCK)</div>'
        };
        return hints[status] || '';
    }

    function renderGateReasonsHTML(gateStatus, gateReasonsJson) {
        if (!gateStatus || gateStatus === 'PASS') return '';
        let reasons = [];
        try { reasons = JSON.parse(gateReasonsJson || '[]'); } catch(e) {}
        if (!reasons.length) return '';
        const color = gateStatus === 'BLOCK' ? '#991b1b' : '#92400e';
        const bg = gateStatus === 'BLOCK' ? '#fef2f2' : '#fffbeb';
        const border = gateStatus === 'BLOCK' ? '#fecaca' : '#fde68a';
        const label = gateStatus === 'BLOCK' ? 'ğŸš« BLOCK' : 'âš ï¸ NEED_FIX';
        return `<div class="gate-reasons-box" style="background:${bg};color:${color};border:1px solid ${border};border-radius:6px;padding:8px 12px;margin-bottom:8px;font-size:13px;">
            <strong>${label}</strong>
            <ul style="margin:4px 0 0 1.2rem;padding:0;">${reasons.map(r => `<li>${r.message || r}</li>`).join('')}</ul>
        </div>`;
    }

    function openEditorWithData(docId, data) {
        currentDocId = docId;
        sourceMapCache = null;
        const container = document.getElementById('editor-container');
        container.innerHTML = '';

        // Add Change Summary if any
        if (data.change_summary) {
            const sumDiv = document.createElement('div');
            sumDiv.className = 'info';
            sumDiv.style.background = '#f0fdf4';
            sumDiv.style.color = '#166534';
            sumDiv.style.border = '1px solid #bbf7d0';
            sumDiv.style.marginBottom = '1rem';
            sumDiv.innerHTML = `<strong>âœ¨ AI ë¶„ì„ ìš”ì•½</strong><br>${data.change_summary}`;
            container.appendChild(sumDiv);
        }

        if (data.todo_questions && data.todo_questions.length > 0) {
            const todoDiv = document.createElement('div');
            todoDiv.className = 'info';
            todoDiv.style.marginBottom = '1rem';
            todoDiv.innerHTML = `<strong>ğŸ“Œ AI ë³´ê°• ìš”ì²­ì‚¬í•­</strong><ul style="margin-left:1.5rem;margin-top:0.5rem;">${data.todo_questions.map(q => `<li>${q}</li>`).join('')}</ul>`;
            container.appendChild(todoDiv);
        }

        // Build gate info map from sections data OR gate_results (from manualize)
        const gateInfo = {};
        if (data.sections_gate) {
            data.sections_gate.forEach(s => {
                gateInfo[s.section_name] = { status: s.gate_status, reasons: s.gate_reasons_json };
            });
        }
        if (data.gate_results) {
            Object.entries(data.gate_results).forEach(([name, g]) => {
                gateInfo[name] = { status: g.status, reasons: JSON.stringify(g.reasons || []) };
            });
        }

        let sectionIndex = 0;
        Object.entries(data.section_details).forEach(([name, text]) => {
            const idx = sectionIndex++;
            const gate = gateInfo[name] || {};
            const gateHTML = renderGateReasonsHTML(gate.status, gate.reasons);
            const gateBadge = _gateBadgeHTML(gate.status);
            const gateHint = _gateHintHTML(gate.status);
            const fillDisabled = (gate.status === 'PASS' || gate.status === 'BLOCK') ? 'disabled style="background:#10b981;color:white;opacity:0.4;cursor:not-allowed;"' : 'style="background:#10b981;color:white;"';
            const secDiv = document.createElement('div');
            secDiv.className = 'card';
            secDiv.style.margin = '0';
            secDiv.innerHTML = `
                ${gateHTML}
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong>${name} ${gateBadge}</strong>
                    <div style="display:flex; gap:0.25rem; align-items:center;">
                        <button class="btn-small" style="background:#64748b;color:white;" onclick="toggleSectionSource(${idx})">ğŸ“„ ì›ë³¸ ë¹„êµ</button>
                        <span id="step1-done-${idx}" style="display:none; color:#10b981; font-weight:700; font-size:13px;">âœ…</span>
                        <button id="btn-fill-${idx}" class="btn-small" ${fillDisabled} onclick="aiRefine(${idx}, 'fill')">â‘  ë§¥ë½ ë³´ê°•</button>
                        <button id="btn-refine-${idx}" class="btn-small" style="background:#6366f1;color:white; opacity:0.5;" onclick="aiRefine(${idx}, 'refine')" disabled>â‘¡ RAG ìµœì í™”</button>
                    </div>
                </div>
                ${gateHint}
                <div id="section-row-${idx}" class="section-row">
                    <div id="source-panel-${idx}" class="source-panel" style="display:none;"></div>
                    <div class="editor-panel">
                        <textarea id="editor-${idx}" class="editor-textarea" data-section-name="${name.replace(/"/g, '&quot;')}" data-gate-status="${gate.status || ''}" oninput="autoResize(this)">${text}</textarea>
                    </div>
                </div>
            `;
            container.appendChild(secDiv);
        });

        document.getElementById('editor-modal').style.display = 'flex';

        // Auto-resize all textareas after rendering
        requestAnimationFrame(() => {
            container.querySelectorAll('.editor-textarea').forEach(ta => autoResize(ta));
        });
    }

    async function openEditor(docId) {
        const res = await fetch(`/api/doc/${docId}/sections`);
        const sections = await res.json();
        const details = {};
        sections.forEach(s => details[s.section_name] = s.section_text);
        openEditorWithData(docId, { section_details: details, todo_questions: [], sections_gate: sections });
    }

    async function qualityGate(docId) {
        showModal('í’ˆì§ˆ ê²€ì‚¬ ë° API ì¶”ì¶œ ì¤‘...', 'ë§¤ë‰´ì–¼ í’ˆì§ˆì„ ê²€ì¦í•˜ê³  ì‹œìŠ¤í…œ ì—°ë™ì„ ìœ„í•œ API ìŠ¤í™ì„ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
        const { ok, data } = await apiCall(`/api/doc/${docId}/quality-gate`);
        if (ok) {
            let apiHtml = '';
            if (data.api_specs && data.api_specs.length > 0) {
                apiHtml = `\n\n[ì¶”ì¶œëœ API ëª©ë¡]\n` + data.api_specs.map(s => `- ${s.intent}: ${s.method} ${s.endpoint}`).join('\n');
            }
            showModal('ê²€ì¦ ë° ì¶”ì¶œ ì™„ë£Œ', `RED: ${data.red_count}, YELLOW: ${data.yellow_count}\n\nì´ìŠˆ:\n${JSON.stringify(data.issues, null, 2)}${apiHtml}`);

            const approveBtn = document.getElementById(`approve-btn-${docId}`);
            if (approveBtn) {
                approveBtn.disabled = data.red_count > 0;
                if (data.red_count > 0) {
                    approveBtn.style.opacity = '0.5';
                    approveBtn.title = "RED ì´ìŠˆë¥¼ í•´ê²°í•´ì•¼ RAG ë°ì´í„°í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                } else {
                    approveBtn.style.opacity = '1';
                    approveBtn.title = "";
                }
            }
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function closeEditor() {
        document.getElementById('editor-modal').style.display = 'none';
    }

    let compareTargetIdx = null;
    let compareTargetTask = null;

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    async function aiRefine(idx, task) {
        const textarea = document.getElementById(`editor-${idx}`);
        const sectionName = textarea.dataset.sectionName;
        const originalText = textarea.value;
        textarea.value = "AIê°€ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...";
        textarea.disabled = true;
        autoResize(textarea);

        const body = { text: originalText, task: task, context: sectionName };
        if (task === 'fill') {
            body.allow_qa = 'false';  // ê¸°ë³¸ê°’: Q&A ì‹ ê·œ ì¶”ê°€ ê¸ˆì§€ (ì•ˆì „)
        }
        const res = await fetch(`/api/doc/${currentDocId}/refine-text`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await res.json();

        textarea.disabled = false;
        textarea.value = originalText;
        autoResize(textarea);

        if (res.ok) {
            openCompare(idx, sectionName, originalText, result.suggestion, task);
        } else {
            alert(result.detail || "AI ìš”ì²­ ì‹¤íŒ¨");
        }
    }

    function openCompare(idx, sectionName, before, after, task) {
        compareTargetIdx = idx;
        compareTargetTask = task;
        const taskLabel = task === 'refine' ? 'â‘¡ RAG ìµœì í™”' : 'â‘  ë§¥ë½ ë³´ê°•';
        document.getElementById('compare-title').textContent = `ğŸ”„ ${taskLabel} ë¹„êµ â€” ${sectionName}`;
        document.getElementById('compare-before').textContent = before;
        const afterTA = document.getElementById('compare-after');
        afterTA.value = after;
        document.getElementById('compare-modal').style.display = 'flex';
        requestAnimationFrame(() => {
            afterTA.style.height = 'auto';
            afterTA.style.height = afterTA.scrollHeight + 'px';
        });
    }

    function closeCompare() {
        document.getElementById('compare-modal').style.display = 'none';
        compareTargetIdx = null;
        compareTargetTask = null;
        // Restore default buttons (in case bulk mode changed them)
        const modal = document.getElementById('compare-modal');
        const footer = modal.querySelector('div[style*="justify-content: flex-end"]');
        if (footer) {
            footer.innerHTML = `
                <button class="btn" style="background:#9ca3af;" onclick="closeCompare()">âŒ ì·¨ì†Œ (ì›ë˜ ìœ ì§€)</button>
                <button class="btn" style="background:#6b7280;" onclick="applyCompareSaveOnly()">âœ… ì ìš©(ì €ì¥)</button>
                <button class="btn" style="background:#3b82f6;" onclick="applyCompareSaveAndGate()">âœ… ì ìš© + Gate ì¬ê²€ì¦</button>
            `;
        }
    }

    async function applyCompareSaveOnly() {
        if (compareTargetIdx === null) return;
        const idx = compareTargetIdx;
        const task = compareTargetTask;
        const textarea = document.getElementById(`editor-${idx}`);
        textarea.value = document.getElementById('compare-after').value;
        autoResize(textarea);
        closeCompare();
        await saveEditor();

        // Mark step 1 done and enable step 2
        if (task === 'fill') {
            const doneEl = document.getElementById(`step1-done-${idx}`);
            if (doneEl) doneEl.style.display = 'inline';
            const refineBtn = document.getElementById(`btn-refine-${idx}`);
            if (refineBtn) {
                refineBtn.disabled = false;
                refineBtn.style.opacity = '1';
            }
        }

        // Set gate_stale flag (saved without gate re-check)
        const sectionName = textarea.dataset.sectionName;
        await setGateStale(sectionName);
        textarea.dataset.gateStatus = 'STALE';
        // Show stale hint on section
        const card = textarea.closest('.card');
        if (card) {
            let staleHint = card.querySelector('.gate-stale-hint');
            if (!staleHint) {
                staleHint = document.createElement('div');
                staleHint.className = 'gate-stale-hint';
                staleHint.style.cssText = 'font-size:12px;color:#d97706;margin-bottom:6px;';
                staleHint.textContent = 'âš ï¸ ë³€ê²½ë¨: Gate ì¬ê²€ì¦ í•„ìš”';
                card.insertBefore(staleHint, card.querySelector('.section-row'));
            }
        }
    }

    async function applyCompareSaveAndGate() {
        if (compareTargetIdx === null) return;
        const idx = compareTargetIdx;
        const task = compareTargetTask;
        const textarea = document.getElementById(`editor-${idx}`);
        textarea.value = document.getElementById('compare-after').value;
        autoResize(textarea);
        closeCompare();
        await saveEditor();

        // Mark step 1 done and enable step 2
        if (task === 'fill') {
            const doneEl = document.getElementById(`step1-done-${idx}`);
            if (doneEl) doneEl.style.display = 'inline';
            const refineBtn = document.getElementById(`btn-refine-${idx}`);
            if (refineBtn) {
                refineBtn.disabled = false;
                refineBtn.style.opacity = '1';
            }
        }

        // Run Gate re-check + update UI
        const sectionName = textarea.dataset.sectionName;
        await runGateAndUpdateUI(idx, sectionName);

        // Remove stale hint if exists
        const card = textarea.closest('.card');
        if (card) {
            const staleHint = card.querySelector('.gate-stale-hint');
            if (staleHint) staleHint.remove();
        }
    }

    // Keep old applyCompare as alias for backward compat
    async function applyCompare() { return applyCompareSaveAndGate(); }

    async function setGateStale(sectionName) {
        try {
            await fetch(`/api/doc/${currentDocId}/section/${encodeURIComponent(sectionName)}/gate-stale`, { method: 'POST' });
        } catch(e) {
            console.error('[GATE_STALE]', e);
        }
    }

    async function runGateAndUpdateUI(idx, sectionName) {
        try {
            const res = await fetch(`/api/doc/${currentDocId}/section/${encodeURIComponent(sectionName)}/gate`, { method: 'POST' });
            if (!res.ok) return;
            const gate = await res.json();
            updateSectionGateUI(idx, gate.status);
        } catch(e) {
            console.error('[GATE_RECHECK]', e);
        }
    }

    function updateSectionGateUI(idx, status) {
        // Update badge
        const textarea = document.getElementById(`editor-${idx}`);
        if (textarea) textarea.dataset.gateStatus = status || '';

        // Update fill button state
        const fillBtn = document.getElementById(`btn-fill-${idx}`);
        if (fillBtn) {
            if (status === 'PASS' || status === 'BLOCK') {
                fillBtn.disabled = true;
                fillBtn.style.opacity = '0.4';
                fillBtn.style.cursor = 'not-allowed';
            } else {
                fillBtn.disabled = false;
                fillBtn.style.opacity = '1';
                fillBtn.style.cursor = 'pointer';
            }
        }
    }

    async function bulkFillNeedFix() {
        const container = document.getElementById('editor-container');
        const textareas = container.querySelectorAll('textarea.editor-textarea');
        const targets = [];
        textareas.forEach((ta, idx) => {
            if (ta.dataset.gateStatus === 'NEED_FIX') {
                targets.push({ idx, name: ta.dataset.sectionName, ta });
            }
        });

        if (!targets.length) {
            alert('NEED_FIX ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const bulkBtn = document.getElementById('btn-bulk-fill');
        if (bulkBtn) { bulkBtn.disabled = true; bulkBtn.textContent = 'ğŸ”§ ì¼ê´„ ë³´ê°• ì¤‘...'; }

        for (const t of targets) {
            // Re-check status (may have changed)
            if (t.ta.dataset.gateStatus !== 'NEED_FIX') continue;

            // 1) Call Fill API
            const body = { text: t.ta.value, task: 'fill', context: t.name, allow_qa: 'false' };
            try {
                const res = await fetch(`/api/doc/${currentDocId}/refine-text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) continue;
                const result = await res.json();

                // 2) Open compare modal and wait for user decision
                const decision = await openBulkCompare(t.idx, t.name, t.ta.value, result.suggestion);

                if (decision === 'skip') continue;

                // 3) Apply + save
                t.ta.value = document.getElementById('compare-after').value;
                autoResize(t.ta);
                closeCompare();
                await saveEditor();

                // 4) Gate re-check
                await runGateAndUpdateUI(t.idx, t.name);

                // 5) Mark step done
                const doneEl = document.getElementById(`step1-done-${t.idx}`);
                if (doneEl) doneEl.style.display = 'inline';
                const refineBtn = document.getElementById(`btn-refine-${t.idx}`);
                if (refineBtn) { refineBtn.disabled = false; refineBtn.style.opacity = '1'; }

            } catch(e) {
                console.error(`[BULK_FILL] Error for ${t.name}:`, e);
            }
        }

        if (bulkBtn) { bulkBtn.disabled = false; bulkBtn.textContent = 'ğŸ”§ NEED_FIX ì¼ê´„ ë³´ê°•'; }
    }

    function openBulkCompare(idx, sectionName, before, after) {
        return new Promise((resolve) => {
            compareTargetIdx = idx;
            compareTargetTask = 'fill';
            document.getElementById('compare-title').textContent = `ğŸ”§ ì¼ê´„ ë³´ê°• â€” ${sectionName}`;
            document.getElementById('compare-before').textContent = before;
            const afterTA = document.getElementById('compare-after');
            afterTA.value = after;
            document.getElementById('compare-modal').style.display = 'flex';
            requestAnimationFrame(() => {
                afterTA.style.height = 'auto';
                afterTA.style.height = afterTA.scrollHeight + 'px';
            });

            // Override buttons for bulk mode
            window._bulkResolve = resolve;
            const modal = document.getElementById('compare-modal');
            // Find buttons in footer
            const footer = modal.querySelector('div[style*="justify-content: flex-end"]');
            if (footer) {
                footer.innerHTML = `
                    <button class="btn" style="background:#9ca3af;" onclick="window._bulkResolve('skip'); closeCompare();">â­ï¸ ê±´ë„ˆë›°ê¸°</button>
                    <button class="btn" style="background:#3b82f6;" onclick="window._bulkResolve('apply');">âœ… ì ìš© + Gate ì¬ê²€ì¦</button>
                `;
            }
        });
    }

    async function saveEditor() {
        const container = document.getElementById('editor-container');
        const textareas = container.querySelectorAll('textarea.editor-textarea');
        const sections = {};
        textareas.forEach(ta => {
            const name = ta.dataset.sectionName;
            if (name) sections[name] = ta.value;
        });

        const res = await fetch(`/api/doc/${currentDocId}/sections`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sections })
        });

        if (res.ok) {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            const data = await res.json();
            alert("ì €ì¥ ì‹¤íŒ¨: " + (data.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        }
    }

    async function revalidateEditor() {
        await saveEditor();
        qualityGate(currentDocId);
    }

    async function apiCall(endpoint, method = 'POST') {
        try {
            const res = await fetch(endpoint, { method });
            const data = await res.json();
            return { ok: res.ok, data };
        } catch (e) {
            return { ok: false, data: { error: e.message } };
        }
    }

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        const body = document.getElementById('modal-body');
        if (typeof content === 'string' && content.includes('<div')) {
            body.innerHTML = content;
        } else {
            body.innerHTML = `<pre style="background:#f5f5f5;padding:1rem;border-radius:4px;white-space:pre-wrap;word-break:break-word;">${typeof content === 'string' ? content : JSON.stringify(content, null, 2)}</pre>`;
        }
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = '';
        btnArea.style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('modal-buttons').innerHTML = '';
        document.getElementById('modal-buttons').style.display = 'none';
    }

    async function extractText(docId) {
        showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘...', '<div style="text-align:center;"><div class="spinner"></div>ë¬¸ì„œì—ì„œ ë‚´ìš©ì„ ì½ì–´ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/extract-text`);
        if (ok) {
            showModal('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ', `ì¶”ì¶œëœ ë¬¸ì: ${data.chars}ì\n\në¯¸ë¦¬ë³´ê¸°:\n${data.preview}`);
        } else {
            showModal('ì˜¤ë¥˜', data.detail || data.error);
        }
    }

    function formatSections(details) {
        if (!details) return '';
        return Object.entries(details).map(([name, text]) => {
            const preview = text.length >= 300 ? text + '...' : text;
            return `ã€${name}ã€‘\n${preview}`;
        }).join('\n\n');
    }

    async function approve(docId) {
        showModal('RAG ë°ì´í„°í™” ì¤‘...', '<div style="text-align:center;"><div class="spinner"></div>ë¬¸ì„œë¥¼ ìŠ¹ì¸í•˜ê³  ê²€ìƒ‰ ì¸ë±ìŠ¤ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</div>');
        const { ok, data } = await apiCall(`/api/doc/${docId}/approve`);
        if (ok) {
            showModal('RAG ë°ì´í„°í™” ì™„ë£Œ', `ìƒíƒœ: ${data.status}\nì²­í¬ ìƒì„±: ${data.reindex.chunk_count}ê°œ\nì´ì œ ì±—ë´‡ì—ì„œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            location.reload();
        } else {
            showModal('ì‹¤íŒ¨', data.detail || data.error);
        }
    }

    function showConfirmModal(title, content, onConfirm) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = content;
        const btnArea = document.getElementById('modal-buttons');
        btnArea.innerHTML = `
            <button class="btn-small" style="background:#9ca3af;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" onclick="closeModal()">ì·¨ì†Œ (ê¸°ì¡´ ìœ ì§€)</button>
            <button class="btn-small" style="background:#8b5cf6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;" id="modal-confirm-btn">ë‹¤ì‹œ ë§¤ë‰´ì–¼í™” (LLM)</button>
        `;
        btnArea.style.display = 'flex';
        document.getElementById('modal-confirm-btn').onclick = () => { closeModal(); onConfirm(); };
        document.getElementById('result-modal').style.display = 'flex';
    }

    async function deleteApartment(aptId, aptName) {
        if (!confirm(`ì•„íŒŒíŠ¸ '${aptName}'ê³¼ ê´€ë ¨ëœ ëª¨ë“  ë¬¸ì„œ, RAG ë°ì´í„°, ëŒ€í™”ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const res = await fetch(`/api/apartments/${aptId}`, { method: 'DELETE' });
        if (res.ok) { alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload(); }
        else { const d = await res.json(); alert('ì‚­ì œ ì‹¤íŒ¨: ' + (d.detail || 'ì˜¤ë¥˜')); }
    }

    async function deleteDocument(docId, title) {
        if (!confirm(`ë¬¸ì„œ '${title}'ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì„¹ì…˜, RAG ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const res = await fetch(`/api/doc/${docId}`, { method: 'DELETE' });
        if (res.ok) { alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); location.reload(); }
        else { const d = await res.json(); alert('ì‚­ì œ ì‹¤íŒ¨: ' + (d.detail || 'ì˜¤ë¥˜')); }
    }

    let sourceMapCache = null;
    async function loadSourceMap() {
        if (sourceMapCache) return sourceMapCache;
        const res = await fetch(`/api/doc/${currentDocId}/source-map`);
        if (!res.ok) return null;
        sourceMapCache = await res.json();
        return sourceMapCache;
    }

    async function toggleSectionSource(idx) {
        const panel = document.getElementById(`source-panel-${idx}`);
        const row = document.getElementById(`section-row-${idx}`);
        if (!panel) return;
        if (panel.style.display !== 'none') {
            panel.style.display = 'none';
            row.classList.remove('section-row-compare');
            return;
        }
        const data = await loadSourceMap();
        if (!data) { alert('ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const ta = document.getElementById(`editor-${idx}`);
        const name = ta.dataset.sectionName;
        const matched = data.source_map[name];
        if (matched) {
            panel.innerHTML = `<div class="source-label">ğŸ“„ ì›ë³¸ í…ìŠ¤íŠ¸</div><div class="source-text">${escapeHtml(matched)}</div>`;
        } else {
            panel.innerHTML = `<div class="source-label">ğŸ“„ ì›ë³¸ í…ìŠ¤íŠ¸ <span style="color:#dc2626;font-size:12px;">(í—¤ë”© ë§¤ì¹­ ì‹¤íŒ¨ â€” ë‹¤ì‹œ Manualize í•´ì£¼ì„¸ìš”)</span></div><div class="source-text">${escapeHtml(data.raw_text)}</div>`;
        }
        panel.style.display = 'block';
        row.classList.add('section-row-compare');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal on outside click
    document.getElementById('result-modal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: auto;
    }

    .editor-modal-content {
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        overflow: hidden;
        padding: 0;
    }

    .editor-header {
        padding: 1.5rem 2rem 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        flex-shrink: 0;
    }

    .editor-header h3 {
        margin-top: 0;
    }

    .editor-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .editor-footer {
        padding: 1rem 2rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .modal-content h3 {
        margin-top: 0;
    }

    .modal-content pre {
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell button {
        margin: 2px;
    }

    .btn-extract {
        background: #6366f1;
    }

    .btn-manualize {
        background: #8b5cf6;
    }

    .btn-view-manual {
        background: #3b82f6;
    }

    .btn-gate {
        background: #f59e0b;
    }

    .btn-approve {
        background: #10b981;
    }

    .text-muted {
        color: #9ca3af;
    }

    /* Auto-expand textareas */
    .editor-textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        overflow: hidden;
        line-height: 1.6;
        box-sizing: border-box;
    }

    /* Comparison modal styles */
    .compare-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .compare-panel {
        display: flex;
        flex-direction: column;
    }

    .compare-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        padding: 6px 12px;
        border-radius: 6px 6px 0 0;
    }

    .compare-panel:first-child .compare-label {
        background: #fef2f2;
        color: #991b1b;
    }

    .compare-panel:last-child .compare-label {
        background: #f0fdf4;
        color: #166534;
    }

    .compare-text {
        background: #fafafa;
        border: 1px solid #e5e7eb;
        border-radius: 0 0 6px 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        flex: 1;
        color: #374151;
        min-height: 350px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .compare-textarea {
        border: 1px solid #86efac;
        border-radius: 0 0 6px 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.6;
        font-family: inherit;
        resize: vertical;
        min-height: 350px;
        max-height: 60vh;
        flex: 1;
        box-sizing: border-box;
    }

    .compare-textarea:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
    }

    .section-row {
        display: flex;
        gap: 1rem;
    }

    .section-row-compare .source-panel {
        flex: 1;
        min-width: 0;
    }

    .section-row-compare .editor-panel {
        flex: 1;
        min-width: 0;
    }

    .editor-panel {
        flex: 1;
        min-width: 0;
    }

    .source-panel {
        display: none;
    }

    .source-label {
        font-weight: 600;
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 4px;
    }

    .source-text {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 10px;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 400px;
        overflow-y: auto;
        color: #374151;
    }

    @media (max-width: 768px) {
        .compare-container {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}