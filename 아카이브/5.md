# 작업 지시 Prompt (Coding AI용) — Gate 버튼 “무반응” UX 개선 (HTMX Pending/팝업 문제 해결)

## 배경/현상
- Upload 탭 문서 목록에서 **Gate 클릭 시 화면상 무반응**
- DevTools Network에서는 `/api/doc/{doc_id}/quality-gate` 요청이 **Pending** 상태로 오래가다가 응답이 오며, 그때 **팝업(alert)** 이 뜨는 경우가 있음
- 사용자는 “작업 진행 중”임을 알 수 없고, 완료 후에도 “결과가 화면에 즉시 반영”되지 않아 UX가 나쁨

## 목표
1) Gate 클릭 즉시 **로딩 표시(Indicator)** + **버튼 비활성화**
2) Gate 완료 후 **RED/YELLOW 결과가 해당 문서 Row 아래에 즉시 표시**되도록 한다
3) 팝업(alert)은 가능한 제거하고, **화면 영역에 메시지/결과를 렌더링**한다
4) 백엔드 로직(품질 검사 자체)은 건드리지 않고, UI/응답 렌더링 중심으로 수정

---

# 1) Frontend(HTMX) 변경 — 로딩/비활성화/결과 영역

## 1-1. templates/upload.html (또는 문서 목록을 그리는 템플릿)
각 문서 row에 Gate 버튼을 아래처럼 수정/추가한다.

### 요구사항
- Gate 버튼에 `hx-indicator` 적용
- Gate 요청 중에는 버튼 클릭 방지: `hx-disabled-elt="this"`
- 결과를 뿌릴 target div 준비: `#gate-result-{doc_id}`
- Gate 완료 후 UI partial을 GET으로 불러와 결과를 갱신한다 (after-request hook)

### 예시 마크업(문서 row 내부)
```html
<button
  type="button"
  class="btn"
  hx-post="/api/doc/{{doc.doc_id}}/quality-gate"
  hx-target="#gate-result-{{doc.doc_id}}"
  hx-swap="innerHTML"
  hx-indicator="#gate-spin-{{doc.doc_id}}"
  hx-disabled-elt="this"
  hx-on::after-request="htmx.ajax('GET','/ui/doc/{{doc.doc_id}}/quality','#gate-result-{{doc.doc_id}}')"
>
  Gate
</button>

<span id="gate-spin-{{doc.doc_id}}" class="htmx-indicator">⏳ 검사 중...</span>

<div id="gate-result-{{doc.doc_id}}"></div>
2) CSS 변경 — indicator 표시
static/style.css
HTMX indicator가 request 중에만 보이게 한다.

.htmx-indicator { display:none; margin-left:8px; }
.htmx-request .htmx-indicator { display:inline; }
3) Backend(UI partial) 추가 — Gate 결과를 HTML로 렌더링
현재 /api/doc/{doc_id}/quality-gate는 JSON을 반환하거나, 팝업으로 보여주는 응답 구조일 가능성이 있음.
HTMX 스왑 대상에 “보기 좋은 HTML”이 필요하므로 UI partial을 추가한다.

3-1. routers/ui.py에 엔드포인트 추가
GET /ui/doc/{doc_id}/quality
최신 품질 결과를 DB에서 조회한다.

RED/YELLOW 카운트와 이슈 목록을 HTML 조각으로 렌더링해서 반환한다.

템플릿 파일을 사용: templates/partials/quality_result.html (신규)

반환 HTML 요구사항
RED: N / YELLOW: M

이슈 목록을 UL 형태로 표시

RED>0 이면 “Approve 불가” 배지

RED=0 이면 “Approve 가능” 배지

YELLOW는 경고 표시로만

4) 템플릿 추가 — quality_result partial
templates/partials/quality_result.html (신규)
입력 컨텍스트 예시:

red_count

yellow_count

issues: [{level:"RED|YELLOW", code:"MISSING|CONFLICT|...", message:"..."}]

예시:

<div class="quality-card">
  <div>
    <strong>Gate 결과</strong>
    <span class="badge red">RED: {{red_count}}</span>
    <span class="badge yellow">YELLOW: {{yellow_count}}</span>
    {% if red_count == 0 %}
      <span class="badge ok">Approve 가능</span>
    {% else %}
      <span class="badge bad">Approve 불가</span>
    {% endif %}
  </div>

  {% if issues and issues|length > 0 %}
    <ul>
      {% for it in issues %}
        <li>
          <strong>[{{it.level}}/{{it.code}}]</strong> {{it.message}}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div>이슈 없음</div>
  {% endif %}
</div>
(필요 시 style.css에 badge 스타일 추가)

5) 팝업(alert) 제거/대체
현재 Gate 처리 후 팝업이 뜨는 경우:

(A) 프론트에서 afterRequest에 alert를 호출하거나

(B) 서버가 4xx/5xx를 반환했는데 프론트가 alert로 처리하거나

(C) 응답이 JSON인데 그대로 alert로 보여주는 로직이 있을 수 있음

요구사항
alert 사용을 제거한다.

에러가 발생하면 #gate-result-{doc_id} 영역에 오류 메시지를 렌더링한다.

Front 처리(권장)
hx-on::response-error 를 사용해 에러 시 target에 메시지 표시:

hx-on::response-error="document.querySelector('#gate-result-{{doc.doc_id}}').innerHTML = '<div class=error>Gate 실패: ' + event.detail.xhr.responseText + '</div>'"
또는 JS helper를 한 번 정의해서 동일 패턴 재사용.

6) 구현 체크리스트(완료 기준)
 Gate 클릭 시 즉시 “⏳ 검사 중…” 표시가 나타난다

 Gate 진행 중 버튼이 비활성화된다(중복 클릭 방지)

 Gate 완료 후 해당 row 아래에 RED/YELLOW 결과와 이슈 목록이 렌더링된다

 팝업(alert)이 더 이상 뜨지 않는다

 오류 시에도 화면에 오류 메시지가 표시된다(Network에서만 보이지 않음)

7) 파일 변경 예상 목록
templates/upload.html (또는 문서 목록 템플릿)

static/style.css

routers/ui.py (GET /ui/doc/{doc_id}/quality 추가)

templates/partials/quality_result.html (신규)

(선택) 공통 JS 또는 base.html에 에러 핸들러 추가

끝.

::contentReference[oaicite:0]{index=0}
