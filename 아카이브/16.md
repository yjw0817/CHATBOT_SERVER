1) FILL_PROMPT v3 â€” allow_qa íŒŒë¼ë¯¸í„° ì§€ì› (Plain Text Output)
FILL_SECTION_TEXT_PROMPT_V3 = """ë‹¹ì‹ ì€ RAG ì²­í¬(ì„¹ì…˜ í…ìŠ¤íŠ¸)ë¥¼ 'ë…ë¦½ì ìœ¼ë¡œ ì´í•´ ê°€ëŠ¥í•œ ë§¤ë‰´ì–¼'ë¡œ ë³´ê°•í•˜ëŠ” í¸ì§‘ìì…ë‹ˆë‹¤.
ì¤‘ìš”: ì´ ì‘ì—…ì€ 'ìƒˆ ì •ë³´ ì¶”ê°€'ê°€ ì•„ë‹ˆë¼, ë™ì¼ ë¬¸ì„œ(raw_text) ë‚´ë¶€ì˜ ê´€ë ¨ ë‚´ìš©ì„ ëª¨ì•„ ì¬êµ¬ì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[ì…ë ¥]
allow_qa: {allow_qa}            # "true" ë˜ëŠ” "false"
section_text: {section_text}    # í˜„ì¬ DBì— ì €ì¥ëœ ì„¹ì…˜ í…ìŠ¤íŠ¸(plain text)
raw_text: {raw_text}            # ë™ì¼ ë¬¸ì„œ ì›ë¬¸(ìµœëŒ€ 4000ì)

[ì ˆëŒ€ ê·œì¹™]
1) ì›ë¬¸ì— ì—†ëŠ” ì •ë³´(ìˆ˜ì¹˜/ê¸°ê°„/ê¸ˆì•¡/ì •ì±…/ì˜ˆì™¸)ë¥¼ ì ˆëŒ€ ë§Œë“¤ì§€ ë§ˆì„¸ìš”.
2) ê·¼ê±°ê°€ ì—†ìœ¼ë©´ ë‚´ìš©ì„ ì±„ìš°ì§€ ë§ê³ , í•´ë‹¹ ì§€ì ì—ë§Œ "[í™•ì¸ í•„ìš”: ë¬´ì—‡ì„ í™•ì¸?]" ë¼ë²¨ì„ ë¶™ì´ì„¸ìš”.
3) ì•”ë¬µ ì¡°ê±´/ì „ì œëŠ” raw_textì— ì•”ì‹œ/í‘œí˜„ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ëª…ì‹œì ìœ¼ë¡œ í’€ì–´ì“°ì„¸ìš”.
4) ì•½ì–´/ë‚´ë¶€ ìš©ì–´ëŠ” ì›ë¬¸ì— ë“±ì¥í•œ ê²ƒë§Œ í’€ì–´ ì„¤ëª…ì„ ì¶”ê°€í•˜ì„¸ìš”. (ì›ë¬¸ì— ì—†ìœ¼ë©´ ê¸ˆì§€)
5) ê°œì¸ì •ë³´(ì „í™”/ì´ë©”ì¼/ê³„ì¢Œ/ìƒì„¸ì£¼ì†Œ/ì‹ë³„ë²ˆí˜¸ ë“±)ëŠ” ***ë¡œ ë§ˆìŠ¤í‚¹ì„ ìœ ì§€í•˜ì„¸ìš”. ì›ë¬¸ì— ìˆì–´ë„ ê·¸ëŒ€ë¡œ ë…¸ì¶œ ê¸ˆì§€.
6) (Q&A ì •ì±… - allow_qaì— ë”°ë¼ ë‹¤ë¦„)
   - allow_qa=false: Q&Aë¥¼ ìƒˆë¡œ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Q&Aë§Œ ë¬¸ë§¥ì„ í•´ì¹˜ì§€ ì•ŠëŠ” ë²”ìœ„ì—ì„œ ìœ ì§€/ì •ë¦¬í•˜ì„¸ìš”.
   - allow_qa=true: ì›ë¬¸ì— ë‹µì´ ëª…í™•íˆ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ Q&Aë¥¼ 1~3ê°œê¹Œì§€ 'ì¶”ê°€'í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     ë‹µì´ ë¶ˆëª…í™•í•˜ë©´ Q&Aë¥¼ ë§Œë“¤ì§€ ë§ê³  "[í™•ì¸ í•„ìš”]"ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.
7) ê¸°ì¡´ section_textì˜ ì£¼ì œ/ë²”ìœ„ë¥¼ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”. (ë‹¤ë¥¸ ì„¹ì…˜ ì£¼ì œë¥¼ ì„ì–´ ë„£ì§€ ë§ ê²ƒ)

[ê°œì„  ëª©í‘œ]
- ì•ë’¤ ì„¹ì…˜ ì—†ì´ë„ ì´ section_textë§Œ ì½ê³  ë‹µë³€ ê°€ëŠ¥í•œ ìˆ˜ì¤€ìœ¼ë¡œ,
  ì›ë¬¸ì— í©ì–´ì§„ ê´€ë ¨ ê·œì¹™/ì¡°ê±´/ì±„ë„/ì˜ˆì™¸ë¥¼ ì´ ì„¹ì…˜ ì•ˆì— í†µí•©í•˜ì„¸ìš”.
- ì¤‘ë³µ bullet ì œê±°, í‘œí˜„ ì •ëˆ, í•­ëª© ì œëª©ì„ ëª…í™•íˆ.
- ë„ˆë¬´ ê¸´ í•­ëª©ì€ ê°™ì€ ì£¼ì œ ì•ˆì—ì„œ 2ê°œë¡œ ìª¼ê°œë˜ í˜•ì‹ì€ ìœ ì§€í•˜ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹(ë°˜ë“œì‹œ ìœ ì§€)]
- ì˜¤ì§ ê°œì„ ëœ section_text ì „ì²´ë¥¼ plain textë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.
- ì„¹ì…˜ ì‹œì‘: "## "
- í•­ëª© ì œëª©: "### "
- ë³¸ë¬¸: "-" bullet
- Q&AëŠ” allow_qa=true ì´ê±°ë‚˜ ì›ë˜ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ, í•­ëª© í•˜ë‹¨ì— ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ í¬í•¨:
  - Q: ...
  - A: ...

[ì¶”ê°€ ê°€ì´ë“œ]
- raw_textì—ì„œ ê·¼ê±°ê°€ ëª…í™•í•œ ë‚´ìš©ë§Œ 'ëª¨ì•„ì„œ' ë„£ê³ , ê·¼ê±° ì—†ëŠ” ë¶€ë¶„ì€ ì±„ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.
- "[í™•ì¸ í•„ìš”]"ëŠ” ë‚¨ë°œí•˜ì§€ ë§ê³  'í•„ìˆ˜ íŒë‹¨ì— í•„ìš”í•œ í•µì‹¬ ë¹ˆì¹¸'ì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
- ì„¤ëª…/í•´ì„¤/JSON ì¶œë ¥ ê¸ˆì§€. ì˜¤ì§ ìµœì¢… í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
"""


í¬ì¸íŠ¸

allow_qa=falseì¼ ë•ŒëŠ” â€œQ&A ì‹ ê·œ ì¶”ê°€â€ê°€ ì™„ì „ ê¸ˆì§€ë¼ì„œ í™˜ê° ìœ„í—˜ì´ í¬ê²Œ ì¤„ì–´ìš”.

allow_qa=trueì¼ ë•Œë„ 1~3ê°œë¡œ ì œí•œ + ê·¼ê±° ëª…í™•í•œ ê²ƒë§Œì´ë¼ ì•ˆì „í•©ë‹ˆë‹¤.

2) íŒŒì´í”„ë¼ì¸ íë¦„ UI ì œì–´ ê·œì¹™ (Gate ê²°ê³¼ ê¸°ë°˜)
ìƒíƒœ â†’ ë²„íŠ¼/íŒíŠ¸ ë§¤í•‘

PASS

Fill ë²„íŠ¼: ë¹„í™œì„±

íŒíŠ¸: âœ… RAG ë°˜ì˜ ê°€ëŠ¥ (PASS)

NEED_FIX

Fill ë²„íŠ¼: í™œì„±

íŒíŠ¸: ğŸ”§ Fill ë³´ê°• â†’ Gate ì¬ê²€ì¦ í•„ìš”

BLOCK

Fill ë²„íŠ¼: ë¹„í™œì„±

íŒíŠ¸: â›” ìˆ˜ë™ ìˆ˜ì • í•„ìš” (BLOCK)

ì¦‰ì‹œ ê°±ì‹  ê·œì¹™

Gate ì‹¤í–‰ ê²°ê³¼ë¥¼ ë°›ëŠ” ì¦‰ì‹œ UIì—ì„œ

ì„¹ì…˜ ë°°ì§€(PASS/NEED_FIX/BLOCK)

Fill ë²„íŠ¼ í™œì„±/ë¹„í™œì„±

íŒíŠ¸ ë¬¸êµ¬
ë¥¼ ì¦‰ì‹œ ë¦¬ë Œë”í•©ë‹ˆë‹¤.

ì¶”ì²œ UX ë””í…Œì¼(í’ˆì§ˆ ì§‘ì¤‘)

PASS ì„¹ì…˜ì€ ì‚¬ìš©ìê°€ êµ³ì´ ë§Œì§€ì§€ ì•Šê²Œ ë§Œë“œëŠ” ê²Œ ì¢‹ìœ¼ë‹ˆ â€œFill ë¹„í™œì„±â€ ìœ ì§€ê°€ ì •ë‹µ.

BLOCKì€ AIê°€ ê±´ë“œë¦¬ë©´ ë” ê¼¬ì¼ í™•ë¥ ì´ ìˆìœ¼ë‹ˆ â€œìˆ˜ë™ ìˆ˜ì •â€ìœ¼ë¡œ ë¹¼ëŠ” ê²Œ ì•ˆì „.

3) â€œğŸ”§ NEED_FIX ì¼ê´„ ë³´ê°•â€ ë²„íŠ¼ ë™ì‘ ê·œì¹™ + ì˜ì‚¬ì½”ë“œ
ìš”êµ¬ ë™ì‘ (ì •ë¦¬)

ë²„íŠ¼ì€ NEED_FIX ì„¹ì…˜ì´ 1ê°œ ì´ìƒì¼ ë•Œë§Œ í™œì„±

í´ë¦­ ì‹œ:

NEED_FIX ì„¹ì…˜ë§Œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬

ê° ì„¹ì…˜ë§ˆë‹¤:

Fill í˜¸ì¶œ(allow_qa ê¸°ë³¸ false ì¶”ì²œ)

diff ëª¨ë‹¬ ì˜¤í”ˆ

ì‚¬ìš©ìê°€ â€œì ìš©/ê±´ë„ˆë›°ê¸°â€ ì„ íƒ

ì ìš©ì´ë©´ ì €ì¥ â†’ Gate ì¬ê²€ì¦ â†’ UI ì¦‰ì‹œ ê°±ì‹ 

ê±´ë„ˆë›°ê¸°ë©´ ë‹¤ìŒ ì„¹ì…˜

ì˜ì‚¬ì½”ë“œ(í”„ë¡ íŠ¸ ê¸°ì¤€)
async function bulkFillNeedFixSections({ allowQaDefault = false }) {
  const targets = sections.filter(s => s.gate_status === "NEED_FIX");
  if (!targets.length) return;

  for (const s of targets) {
    // ìµœì‹  ìƒíƒœê°€ ë³€í–ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë°©ì–´ì ìœ¼ë¡œ ì²´í¬
    if (s.gate_status !== "NEED_FIX") continue;

    // 1) Fill ì œì•ˆ ë°›ê¸°
    const proposal = await api.fillSection({
      doc_id,
      section_name: s.section_name,
      section_text: s.section_text,
      raw_text: raw_text_4000,
      allow_qa: allowQaDefault
    });

    // 2) diff ëª¨ë‹¬
    const decision = await openDiffModal({
      before: s.section_text,
      after: proposal.section_text
    }); // returns { action: "apply" | "skip" }

    if (decision.action === "skip") continue;

    // 3) ì ìš© + ì €ì¥
    await api.updateSectionText({
      doc_id,
      section_name: s.section_name,
      section_text: proposal.section_text
    });

    // 4) Gate ì¬ê²€ì¦(ì¦‰ì‹œ)
    const gate = await api.gateSection({
      doc_id,
      section_name: s.section_name,
      section_text: proposal.section_text,
      raw_text: raw_text_4000
    });

    // 5) UI ê°±ì‹ 
    updateSectionStateUI(section_name, {
      section_text: proposal.section_text,
      gate_status: gate.status,
      gate_score: gate.score,
      gate_reasons: gate.reasons
    });
  }
}

ìš´ì˜ ê¸°ë³¸ê°’ ì¶”ì²œ

ì¼ê´„ ë³´ê°•ì€ allow_qa=false ê¸°ë³¸ì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.

í•„ìš”í•˜ë©´ â€œì˜µì…˜ í† ê¸€â€ë¡œ allow_qa=trueë¥¼ ì¼¤ ìˆ˜ ìˆê²Œë§Œ ì œê³µ.

ì¶”ê°€ë¡œ ë”± 1ê°œë§Œ ë”(í’ˆì§ˆì— ì§ê²°)

ì¼ê´„ ë³´ê°• ì‹œì—ëŠ” raw_text(4000ì) ì˜ë¦¼ ë•Œë¬¸ì— ê·¼ê±° ë¶€ì¡±ì´ ìƒê¸°ê¸° ì‰¬ì›Œìš”.
ê°€ëŠ¥í•˜ë©´ Fill/Gate í˜¸ì¶œì— raw_evidence(ì„¹ì…˜ ê´€ë ¨ ë°œì·Œ)ë„ ê°™ì´ ë„˜ê¸°ë©´ í’ˆì§ˆì´ í™• ì˜¬ë¼ê°‘ë‹ˆë‹¤.
(ì§€ê¸ˆ ë‹¹ì¥ ì•ˆ í•´ë„ ë˜ì§€ë§Œ, â€œí’ˆì§ˆâ€ë§Œ ë³´ë©´ ì´ê²Œ ê°€ì¥ í° ë ˆë²„ì…ë‹ˆë‹¤.)