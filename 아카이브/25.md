🎯 목표

영업/운영 문서를 RAG에 넣기 전에

LLM으로 구조화된 매뉴얼 섹션으로 변환하고

Gate QA로 품질을 검증한 뒤

신뢰 가능한 섹션만 RAG에 반영한다.

핵심:

❌ 문서 전체 1방 처리 금지

✅ Chunk(섹션) 단위 처리 + 근거 기반 검증

✅ 인덱스(char_start/end)는 서버가 계산, LLM에게 맡기지 않음

1) 전체 파이프라인

Raw Document
→ Split
→ Chunks (anchor 기반 범위 확정)
→ Manualize
→ section_text + evidence_spans
→ Gate QA
→ PASS / NEED_FIX / BLOCK
→ Merge
→ Final Manual → RAG

2) 단계별 역할/규칙
(1) Split (문서 분할)
목적

문서를 단일 주제 단위 chunk로 분할.

규칙

헤더(##, ###) 우선 분할

번호/제목 패턴 보조

단일 주제 유지

길이: 목표 3k~8k자, 최대 12k자

Split 출력(LLM)

각 chunk는 아래 필드 포함:

chunk_id

start_anchor (원문 그대로 복사)

end_anchor (원문 그대로 복사)

split_basis

notes: 분할 근거 1문장(요약 금지)

서버 역할(필수)

anchor로 char_start/char_end 계산 (LLM 계산 금지)

end_anchor 중복 가능 → 반드시 find(end_anchor, char_start) 형태로 검색

(2) Manualize (매뉴얼화)
목적

raw_chunk → 실행 가능한 매뉴얼 섹션으로 변환.

포함(있는 것만)

절차 / 조건·대상 / 예외 / 기한·기간 / 금액·정산 / 담당·채널

금지

원문에 없는 정보 추가

추측/일반화

홍보/배경 설명 과다

PII 그대로 노출

필수 조건

text는 ##로 시작

최소 ### 1개 이상

evidence_spans 최소 2개 이상

🔒 PII 규칙(중요)

원문에 PII가 있어도 그대로 복사 금지 → 반드시 마스킹

010-1234-5678 → 010-****-5678

abc@email.com
 → ab***@email.com

Evidence Span 규칙(치명 포인트)

span_text는 raw_chunk 발췌 기반

PII 포함 시 반드시 마스킹 저장(원문 그대로 복사 예외)

의미 보존이 핵심(문자 1:1 동일성 필수 아님)

서버 역할(필수)

span_text를 raw_chunk.find(span_text)로 인덱싱

실패 시 char_start=-1 기록, drop 금지

📌 PII Span 인덱싱(정책 고정)

마스킹된 span_text는 raw_chunk에서 find 불가할 수 있음 → 정상

PII 포함 span은 find를 시도하지 않고 char_start=-1로 기록 가능(정상 동작)

(3) Gate QA
목적

Manualize 결과 품질 검증.

입력(매우 중요)

section_text = manualized text

raw_text = raw_chunk ONLY
⚠️ 문서 전체 raw_text를 Gate에 넣지 않음(토큰 폭발/대조 실패)

판정

PASS → RAG 후보

NEED_FIX → 편집 큐

BLOCK → 반영 금지

원칙:

증거 기반만 지적, 추측 금지

PII/환각/대량누락 엄격 검출

Gate Prompt: V4.2.5a 사용

(4) Merge
목적

검증된 섹션을 병합해 최종 매뉴얼 생성.

규칙

PASS 우선

NEED_FIX는 appendix 분리

chunk 순서 유지

용어/문체 통일

중복 제거는 보수적으로(동일 제목 + 매우 유사한 경우만, 애매하면 유지)

Merge는 Gate 결과만 사용(새 규칙/수치/절차 생성 금지)

본문은 PASS만, NEED_FIX는 부록

안정성 옵션

PASS 섹션이 많아 Merge 입력이 커지면:

10~20개 단위 부분 Merge → 최종 Merge 1회

3) 재시도 규칙(최대 1회)

Split: anchor 매칭 실패 → 1회 재시도

Manualize: evidence_spans < 2 → 1회 재시도

Span 인덱싱: 실패 시 -1 기록(drop 금지)

4) Publish(=RAG 반영) 기본 정책 (고정)

span 인덱싱 실패(-1)가 1개라도 있으면 Gate가 PASS여도 Publish 제외

RAG 반영 조건:

Gate = PASS

모든 span 인덱싱 성공(= char_start/char_end 정상)

5) ✅ -1 값 해석 규칙 (최종 1줄 패치)

char_start=-1은 두 경우를 의미하므로 구분한다:

PII 마스킹으로 인덱싱을 의도적으로 스킵한 정상 케이스

비PII span 매칭 실패인 이상 케이스
→ 따라서 각 evidence_span에 is_pii(true/false) 플래그를 함께 기록한다.

적용 방식

DB 컬럼 추가 불필요

evidence_json에만 is_pii 포함

예:

{
  "span_text": "010-****-5678",
  "maps_to": "연락처 안내",
  "char_start": -1,
  "char_end": -1,
  "is_pii": true
}



구현 체크 2개

1. is_pii=true는 PII 패턴 감지 + 마스킹 적용한 span에만 부여(서버 기준)
2. Publish 제외 조건(“-1 하나라도 제외”)은 is_pii=true/false 모두 동일 적용(기본 정책)