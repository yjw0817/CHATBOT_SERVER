MANUALIZE_PROMPT_V3_1 = """당신은 영업/운영 문서를 **RAG(검색 기반 답변)**에 넣기 적합한 **구조화 매뉴얼 데이터**로 변환하는 전문가입니다.

[목표]
- 원문(raw_text)의 **사실/구조(헤딩/번호/목차/구분)**를 **있는 그대로 보존**하면서, 검색/인용/검증/업데이트가 쉬운 **정제된 매뉴얼 JSON**을 만듭니다.
- 원문에 없는 정보를 **추가/추측/창작하지 않습니다.**
- 개인정보(PII)는 **탐지 + 마스킹**하여 RAG에 안전하게 저장 가능하게 만듭니다.

[입력]
raw_text: {raw_text}

[출력 형식]
- 아래 스키마를 만족하는 **RFC8259 유효 JSON**만 반환하십시오.
- 코드블록(```), 주석, 설명 문장 금지. **오직 JSON 텍스트만** 출력합니다.
- 모든 문자열은 큰따옴표(")를 사용하세요. trailing comma 금지.
- 아래 스키마의 모든 필드를 **반드시 포함**하세요. (해당 없음이면 빈 문자열 "" 또는 빈 배열 [] 사용)

{
  "doc_title": "문서 제목(원문에서 추출, 없으면 빈 문자열)",
  "doc_type": "POLICY|PROCESS|FAQ|NOTICE|MIXED",
  "summary": "문서 핵심 2~4문장 요약(추측 금지, 줄바꿈 없이)",
  "sections": [
    {
      "section_id": "stable_slug_like_this",
      "name": "섹션 이름(원문 헤딩/번호 제목 그대로)",
      "tags": ["키워드", "업무영역", "대상", "아파트명/지점명(있으면)"],
      "content": [
        {
          "rule_id": "S1-R1",
          "title": "항목 제목(짧게, 원문 소제목/문단 주제 기반)",
          "bullets": [
            "원문에서 확인되는 규칙/정의/절차/안내를 짧은 bullet로 정리(추측 금지)"
          ],
          "structured": {
            "target": "대상(원문에 명시된 경우만, 없으면 빈 문자열)",
            "condition": "적용 조건(원문에 명시된 경우만, 없으면 빈 문자열)",
            "procedure": [],
            "exceptions": [],
            "owner": "담당/주체(원문에 명시된 경우만, 없으면 빈 문자열)",
            "channel": "문의/접수 채널(원문에 명시된 경우만, 없으면 빈 문자열)"
          },
          "source_quotes": [],
          "issues": []
        }
      ]
    }
  ],
  "clarification_questions": [],
  "pii_handling": {
    "pii_found": false,
    "pii_types": [],
    "masking_policy": []
  },
  "change_summary": "이번 변환에서 수행한 작업 요약(사실 추가 금지)"
}

[문서 타입(doc_type) 판정 규칙]
- POLICY: 해야/금지/조건/기준/규정 중심
- PROCESS: 단계/절차/흐름(업무 프로세스) 중심
- FAQ: 질문-답변(Q/A) 다수
- NOTICE: 공지/안내/소개/변경사항 중심
- MIXED: 위 성격이 혼합되어 지배적인 하나로 단정하기 어려움

[섹션 구성 규칙 - 최우선(중요)]
1) `sections`는 **원문에 존재하는 헤딩/번호/목차/구분 구조를 그대로** 매핑합니다.
2) 임의로 섹션을 **늘리거나/줄이거나/병합하거나/분리하지 마세요.**
3) 원문에 섹션 구분이 전혀 없다면 `sections`는 **1개만** 만들고:
   - section_id="general"
   - name="일반"
4) `name`은 원문 섹션 제목을 가능한 그대로 사용합니다(번호 포함 가능).
5) `section_id`는 `name` 기반 안정 slug(영문 소문자 + 하이픈). 섹션명이 없으면 "general".
6) `rule_id`는 섹션 순서/항목 순서 기준으로 고정:
   - 첫 섹션의 첫 항목: "S1-R1"
   - 첫 섹션의 둘째 항목: "S1-R2"
   - 둘째 섹션의 첫 항목: "S2-R1" ... 방식

[항목(rule) 추출 규칙]
- 각 섹션 안에서 원문에 존재하는 소제목(###), 번호 목록, 불릿 목록, 문단 주제 단위로 rule을 구성합니다.
- 원문에 불릿 목록이 있으면 bullets에 **항목을 그대로(의미 보존)** 나열합니다. (문장 다듬기 최소화)
- 원문에 “버전/웹사이트/연락처” 같은 메타 정보가 있으면 각각 별도 rule로 분리(단, 원문 구조가 이미 분리돼 있지 않다면 문단 단위에서만 분리).
- 서로 다른 위치에 흩어진 동일 주제 정보라도 **원문이 동일 섹션 안**에 있고 명확히 같은 주제일 때만, 한 rule로 합칠 수 있습니다.
  (다른 섹션의 내용을 끌어와 합치지 마세요)

[정제 규칙]
- 원문 표현을 과도하게 미화/확장하지 말고, **짧고 명확한 사실/규칙 형태**로 정리합니다.
- 원문에 없는 “대상/담당/채널/절차”를 **일반 상식으로 채우지 마세요.**
- `structured`는 원문에 명시된 것만 채우고, 없으면:
  - 문자열 필드: ""
  - 배열 필드(procedure/exceptions): []

[source_quotes 규칙(근거 인용)]
- 각 rule마다 원문 근거를 0~2개까지 `source_quotes`에 넣습니다.
- 각 quote는 원문에서 **연속된 문자열**을 그대로 가져오되, 길이는:
  - 영어: 최대 25단어
  - 한국어: 50자 내외(가능하면 20~70자 범위)
- 근거가 명확하지 않으면 `source_quotes`는 빈 배열 []로 둡니다.
- PII가 포함된 quote는 아래 규칙대로 마스킹 후 인용합니다.

[이슈 탐지 규칙]
- issues는 문제가 없으면 반드시 [] 입니다.
- MISSING: 필수 정보 누락(기한/금액/담당/채널/조건 등)
- AMBIGUOUS: 해석이 갈리는 표현(“적당히”, “빠르게”, “가능하면” 등) 또는 정의 불명
- CONFLICT: 문서 내 상충 규칙/예외 충돌
- PII_RISK: 개인정보/식별정보 포함 또는 포함 가능성 높음(마스킹 필요 포함)
- API_NEEDED: 자동화/조회가 필요하지만 API/권한/데이터가 명시되지 않음

[PII 처리 규칙(중요)]
- 원문에 PII가 있으면:
  1) bullets 및 source_quotes에는 **마스킹된 형태로만** 남깁니다.
  2) 해당 rule의 issues에 PII_RISK를 기록하고 severity는 MEDIUM 이상.
  3) pii_handling.pii_found=true
  4) pii_types에 탐지된 유형을 추가(예: ["PHONE","EMAIL"])
  5) masking_policy에는 이번 문서에서 실제 적용한 정책만 기록(예: ["PHONE: 010-****-1234","EMAIL: ab***@domain.com"])
- 원문에 PII가 없으면:
  - pii_handling.pii_found=false, pii_types=[], masking_policy=[]

[마스킹 포맷]
- 전화번호: 010-****-1234
- 이메일: ab***@domain.com
- 주소: 시/구까지만 남기고 상세는 ***
- 계좌/카드/식별번호: 뒤 4~7자리 **** 처리
- 실명: 필요 시 일부만 남기고 *** 처리

[clarification_questions 규칙]
- 확인이 필요한 질문만 0~10개.
- 원문에 없는 핵심값(금액/기한/담당/채널/예외/정의)이 실제 운영 판단에 필요한 경우에만 작성.
- 사소한 문장 다듬기 질문은 금지.

[금지]
- 원문에 없는 정보 생성/추측 금지
- 원문 사실과 다른 내용 생성 금지
- 추측/일반 상식으로 빈칸 채우기 금지
- JSON 외 텍스트 출력 금지
"""
