# 작업 지시 Prompt (Coding AI용) — Gate 버튼 UX 개선: Pending 동안 로딩 + 완료 시 모달 팝업으로 결과 표시

## 현상
- Gate 클릭 시 화면상 무반응
- Network에서 Pending(처리 오래 걸림) 후 응답
- 현재 팝업이 뜨긴 하나, 진행 중 표시가 없고/팝업 내용이 부족하거나 일관되지 않음

## 목표
1) Gate 클릭 즉시 사용자에게 반응 제공: 로딩 표시 + 버튼 비활성화
2) Gate 완료 시 결과를 "행 아래"가 아니라 "모달 팝업"으로 표시(선호 UX)
3) 팝업에는 RED/YELLOW 카운트 + 이슈 리스트를 보기 좋게 표시
4) 에러도 팝업에 표시
5) 백엔드 품질 검사 로직은 그대로 두고(UI/응답 렌더링 중심)

---

# 1) UI: 공용 모달 1개 추가 (base.html 또는 upload.html)
## 요구사항
- 페이지에 한 번만 존재하는 모달 컨테이너를 만든다.
- 모달 내용은 HTMX로 교체한다.

예시(간단 모달):
```html
<div id="modal-backdrop" class="modal-backdrop" style="display:none;"></div>

<div id="modal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <div id="modal-title">Gate 결과</div>
      <button type="button" id="modal-close" class="btn" onclick="closeModal()">X</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<script>
function openModal(title){
  document.getElementById('modal-title').innerText = title || 'Gate 결과';
  document.getElementById('modal-backdrop').style.display = 'block';
  document.getElementById('modal').style.display = 'block';
}
function closeModal(){
  document.getElementById('modal-backdrop').style.display = 'none';
  document.getElementById('modal').style.display = 'none';
  document.getElementById('modal-body').innerHTML = '';
}
</script>
2) CSS: 모달 스타일 + HTMX 로딩 indicator
static/style.css에 추가:

.htmx-indicator { display:none; margin-left:8px; }
.htmx-request .htmx-indicator { display:inline; }

.modal-backdrop{
  position:fixed; left:0; top:0; right:0; bottom:0;
  background:rgba(0,0,0,.35);
  z-index:999;
}
.modal{
  position:fixed; left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:min(900px, 92vw);
  max-height:85vh;
  overflow:auto;
  background:#fff;
  z-index:1000;
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.modal-content{ padding:16px; }
.modal-header{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:12px;
}
3) Backend: Gate 결과를 HTML partial로 반환하는 UI 엔드포인트 추가
목적
/api/doc/{doc_id}/quality-gate 는 검사 수행(저장)만 담당 (JSON OK)

팝업 내용은 /ui/doc/{doc_id}/quality 가 HTML로 렌더링해서 제공

추가: GET /ui/doc/{doc_id}/quality
DB에서 해당 doc_id의 최신 quality 결과를 읽는다

templates/partials/quality_modal.html 로 렌더링해 HTML 반환

templates/partials/quality_modal.html 에 포함:

RED/YELLOW badge

issues 리스트 (RED/YELLOW 구분)

Approve 가능 여부(RED=0이면 가능)

4) Upload 화면: Gate 버튼에 로딩/비활성화 + 완료 후 모달 오픈 + partial 로드
각 문서 row에서 Gate 버튼을 아래처럼 수정:

<button
  type="button"
  class="btn"
  hx-post="/api/doc/{{doc.doc_id}}/quality-gate"
  hx-trigger="click"
  hx-indicator="#gate-spin-{{doc.doc_id}}"
  hx-disabled-elt="this"
  hx-on::before-request="openModal('Gate 검사 중...'); document.querySelector('#modal-body').innerHTML='처리 중입니다...';"
  hx-on::after-request="htmx.ajax('GET','/ui/doc/{{doc.doc_id}}/quality','#modal-body'); openModal('Gate 결과');"
  hx-on::response-error="openModal('Gate 실패'); document.querySelector('#modal-body').innerHTML = '<pre style=\"white-space:pre-wrap\">'+ event.detail.xhr.responseText +'</pre>';"
>
  Gate
</button>
<span id="gate-spin-{{doc.doc_id}}" class="htmx-indicator">⏳</span>
설명:

클릭 즉시 모달을 띄워 “처리 중” 상태 표시(무반응 해결)

POST 완료 후 UI partial을 GET으로 받아 modal-body에 넣음

에러면 modal-body에 에러 표시

5) 완료 기준
 Gate 클릭 즉시 모달이 뜨고 "처리 중" 표시가 나온다

 Pending 동안 버튼이 비활성화되고 spinner가 나온다

 완료되면 모달 내용이 RED/YELLOW 및 이슈 리스트로 바뀐다

 에러도 모달에 출력된다

 행 아래에는 아무것도 추가 표시하지 않는다(팝업 선호 UX 유지)

6) 변경 파일 목록
templates/base.html 또는 templates/upload.html (모달 컨테이너 + 스크립트 추가)

static/style.css (indicator + modal 스타일)

routers/ui.py (GET /ui/doc/{doc_id}/quality 추가)

templates/partials/quality_modal.html (신규)

templates/upload.html (Gate 버튼 HTMX 속성 수정)

끝.


---

원하면 팝업을 “브라우저 alert” 말고 지금처럼 **깔끔한 모달**로 고정해서, Extract/Manualize/Approve도 같은 모달로 통일하는 UX도 같이 잡아줄게.
::contentReference[oaicite:0]{index=0}