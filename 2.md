# STEP 2 구현 지시 — Manualization & Quality Gate & Approve/Reindex (SQLite 유지)

현재 Step 1까지 완료됨(FastAPI + SQLite + UI 4화면 + 업로드/버전관리).
이제 Step 2를 구현해줘. 목표는 “업로드된 DOCX → 텍스트 추출 → 매뉴얼화(6섹션) → 품질게이트(R/Y) → 승인 → 재색인(청킹)”까지 end-to-end로 동작하게 하는 것.

## A) DOCX 텍스트 추출 (필수)
- 업로드된 문서 파일은 uploads/에 저장되어 있음.
- doc_id로 documents 테이블에서 filename/path를 찾아서 텍스트를 추출해라.
- 우선 DOCX만 100% 지원. PDF는 이번 단계에서 OPTIONAL(가능하면 텍스트만).
- Python 라이브러리: python-docx 사용.

### 구현
1) documents에 raw_text 컬럼이 없다면 추가하거나,
   또는 manualize 시점에 추출한 텍스트를 임시 변수로 사용해도 됨(권장: documents.raw_text TEXT 추가).
2) POST /api/doc/{doc_id}/extract-text
   - doc 파일 확장자 확인
   - docx면 텍스트 추출 → documents.raw_text에 저장
   - 반환: {success, doc_id, chars, preview(앞 300자)}

## B) Manualization (LLM)
- POST /api/doc/{doc_id}/manualize
- 입력: documents.raw_text
- 출력: “정확한 JSON” 6개 섹션 키 고정:
  1) 운영시간/휴무
  2) 예약/취소/변경
  3) 강좌/정원/대기
  4) 환불/위약/정산
  5) 공지/문자 규칙
  6) 예외/문의/권한

### 저장
- manual_sections 테이블에 section_name, section_text로 저장(6행).
- 기존 섹션이 있으면 덮어쓰기(해당 doc_id 삭제 후 재삽입 또는 upsert).
- documents.status는 DRAFT 유지.

### Manualization Prompt 규칙
- 없는 내용을 만들지 말 것(추정/창작 금지).
- 문장 짧게, 가능한 bullet.
- 모호한 부분은 “확인 필요:” 라벨로 표시해도 됨.

## C) Quality Gate (LLM + 간단 룰)
- POST /api/doc/{doc_id}/quality-gate
- 입력: manual_sections(6개) 전체
- 출력: 이슈 배열 JSON:
  - severity: "RED" | "YELLOW"
  - issue_type: "MISSING" | "AMBIGUOUS" | "CONFLICT" | "PII_RISK" | "API_NEEDED"
  - message: 한 줄 설명
  - suggestion: 어떻게 고치면 되는지 한 줄

### Quality Gate 규칙(최소)
- MISSING(RED): 환불/예약/운영시간/권한 중 핵심이 완전히 비어있거나 기준이 없음
- AMBIGUOUS(YELLOW/RED): “상황에 따라/가능하면/적당히/협의 후” 등 모호 표현
- CONFLICT(RED): 같은 주제에서 상반된 규칙
- PII_RISK(RED): 주민번호/전화번호 패턴 등(정규식으로 1차 탐지 후 LLM 확인)
- API_NEEDED(YELLOW): “예약 생성/변경”, “문자 발송”, “강좌 추가/삭제” 등 시스템 액션이 필요한 문구 발견

### 저장
- qa_issues 테이블에 doc_id별로 저장.
- 기존 이슈가 있으면 초기화 후 재생성.

## D) Approve (RED 없을 때만)
- POST /api/doc/{doc_id}/approve
- 조건: qa_issues에 status=OPEN인 RED가 0개일 것
- 승인 시:
  - documents.status = "APPROVED"
  - 즉시 reindex 실행(아래 E 호출)

## E) Reindex / Chunking (임베딩 금지, 키워드 검색용)
- POST /api/doc/{doc_id}/reindex
- manual_sections의 텍스트를 400~600 chars 단위로 청킹, overlap 100 chars.
- chunks 테이블에 insert:
  - doc_id, section_name, chunk_index, chunk_text
- 기존 chunks는 삭제 후 재생성.
- 반환: {success, chunk_count}

## F) UI 연결(필수)
Upload 화면(upload.html)에 문서 리스트가 있으니, 각 문서에 버튼을 붙여라:
- [Extract Text]
- [Manualize]
- [Quality Gate]
- [Approve] (RED 있으면 비활성 또는 실패 메시지)
- [Reindex]

Quality 화면(quality.html):
- RED / YELLOW 그룹으로 이슈 표시.

## G) Acceptance (이거 100% 충족)
1) docx 업로드 → Extract Text 성공(chars>0)
2) Manualize 실행 → manual_sections 6개 생성
3) Quality Gate 실행 → qa_issues 생성(없어도 ok)
4) RED 없으면 Approve 성공 → status APPROVED
5) Approve 시 chunks 생성(chunk_count>0)

## H) 출력
- 변경된 파일 목록
- 실행 방법 동일(uvicorn)
- 간단 테스트 순서(어떤 버튼/어떤 API 호출하면 되는지)

